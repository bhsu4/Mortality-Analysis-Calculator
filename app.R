library(shiny)
library(shinyjs)
library(datasets)
library(tidyverse)
library(devtools)
library(shinycssloaders)

library(shinydashboard)
library(shinydashboardPlus)
library(shinycssloaders)

library(dashboardthemes)
library(leaflet)
library(leaflet.extras)
library(RMySQL)
library(plotly)
library(heatmaply)
library(shinyHeatmaply)
library(shinyWidgets)
library(slickR)

#changes life exp
library("gplots")
library(HMDHFDplus)
library(reshape2)
library(RColorBrewer)

options(HMD_user = "bh2722@columbia.edu")
options(HMD_password = "password999")

logotitle <- shinyDashboardLogoDIY(boldText = "", mainText = "MortalityViz", textSize = 14, badgeText = "BETA",  
                                    badgeTextColor = "black", badgeTextSize = 2, badgeBackColor = "#DCDCDC", badgeBorderRadius = 2)

#sysfonts::font_add_google("Roboto Condensed", regular.wt = 400, bold.wt = 700)
#dir.create('~/.fonts')
#file.copy("www/RobotoCondensed.ttf", "~/.fonts")
#system('fc-cache -f ~/.fonts')

theme_custom <- shinyDashboardThemeDIY(
    
    ### general
    appFontFamily = "Arial"
    ,appFontColor = "rgb(0,0,0)"
    ,primaryFontColor = "rgb(0,0,0)"
    ,infoFontColor = "rgb(0,0,0)"
    ,successFontColor = "rgb(0,0,0)"
    ,warningFontColor = "rgb(0,0,0)"
    ,dangerFontColor = "rgb(0,0,0)"
    ,bodyBackColor = "rgb(236,242,247)"
    
    ### header
    ,logoBackColor = "rgb(53,64,83)" #mortalityviz background
    
    ,headerButtonBackColor = "rgb(255,255,255)" #white background for lines button 
    ,headerButtonIconColor = "rgb(125,132,145)" #grey three lines 
    ,headerButtonBackColorHover = "rgb(21, 154, 251)" #bright blue
    ,headerButtonIconColorHover = "rgb(0,0,0)" #black hover three lines = black lines
    
    ,headerBackColor = "rgb(255,255,255)"  #rest of header back color = white
    ,headerBoxShadowColor = "rgb(232,232,232)" 
    ,headerBoxShadowSize = "2px 2px 2px"
    
    ### sidebar
    ,sidebarBackColor = "rgb(53,64,83)"
    ,sidebarPadding = 0 #left side selected tab
    
    ,sidebarMenuBackColor = "rgb(53,64,83)" #"transparent" for sidebar collapse menu
    ,sidebarMenuPadding = 0
    ,sidebarMenuBorderRadius = 5
    
    ,sidebarShadowRadius = "2px 2px 2px" #sidebar shadow
    ,sidebarShadowColor = "#aaaaaa"
    
    ,sidebarUserTextColor = "rgb(0,0,0)"
    
    ,sidebarSearchBackColor = "rgb(55,72,80)"
    ,sidebarSearchIconColor = "rgb(153,153,153)"
    ,sidebarSearchBorderColor = "rgb(55,72,80)"
    
    #for unselected sidebars = dark blue shading and grey text
    ,sidebarTabTextColor = "rgb(125,132,145)" #grey text color
    ,sidebarTabTextSize = 14
    ,sidebarTabBorderStyle = "none none none none" #border clockwise from top
    ,sidebarTabBorderColor = ""
    ,sidebarTabBorderWidth = 20
    
    #selected sidebar = darker blue shading, w/ white text
    ,sidebarTabBackColorSelected = "rgb(46,58,72)" #selected even darker blue
    ,sidebarTabTextColorSelected = "rgb(255,255,255)" #white text
    ,sidebarTabRadiusSelected = "0px 0px 0px 0px" #rectangular
    
    #hovering sidebar = darker blue shading w/ grey text
    ,sidebarTabBackColorHover = "rgb(46,58,72)" #hover same as selected = even darker blue
    ,sidebarTabTextColorHover = "rgb(125,132,145)" #but hover not selected = grey text
    ,sidebarTabBorderStyleHover = "none none none solid"
    ,sidebarTabBorderColorHover = "rgb(21, 154, 251)" #bright blue hovering left padding
    ,sidebarTabBorderWidthHover = 5
    ,sidebarTabRadiusHover = "0px 0px 0px 0px"
    
    ### boxes
    ,boxBackColor = "rgb(255,255,255)"
    ,boxBorderRadius = 5
    ,boxShadowSize = "0px 1px 1px"
    ,boxShadowColor = "rgba(0,0,0,.1)"
    ,boxTitleSize = 16
    ,boxDefaultColor = "rgb(111,125,150)" #grey
    ,boxPrimaryColor = "rgb(71,186,193)" #teal
    ,boxInfoColor = "rgb(21, 154, 251)" #bright blue
    ,boxSuccessColor = "rgb(67, 138, 250)"
    ,boxWarningColor = "rgb(244,156,104)"
    ,boxDangerColor = "rgb(111,125,150)" #grey
    
    ,tabBoxTabColor = "rgb(255,255,255)"
    ,tabBoxTabTextSize = 14
    ,tabBoxTabTextColor = "rgb(0,0,0)"
    ,tabBoxTabTextColorSelected = "rgb(0,0,0)"
    ,tabBoxBackColor = "rgb(255,255,255)" 
    ,tabBoxHighlightColor = "rgb(21, 154, 251)" #"rgb(111,125,150)" #rim of tab boxes of non seelected
    ,tabBoxBorderRadius = 0
    
    ### inputs
    ,buttonBackColor = "rgb(245,245,245)"
    ,buttonTextColor = "rgb(0,0,0)"
    ,buttonBorderColor = "rgb(200,200,200)"
    ,buttonBorderRadius = 5
    
    ,buttonBackColorHover = "rgb(235,235,235)"
    ,buttonTextColorHover = "rgb(100,100,100)"
    ,buttonBorderColorHover = "rgb(200,200,200)"
    
    ,textboxBackColor = "rgb(255,255,255)"
    ,textboxBorderColor = "rgb(200,200,200)"
    ,textboxBorderRadius = 5
    ,textboxBackColorSelect = "rgb(245,245,245)"
    ,textboxBorderColorSelect = "rgb(200,200,200)"
    
    ### tables
    ,tableBackColor = "rgb(255,255,255)"
    ,tableBorderColor = "rgb(240,240,240)"
    ,tableBorderTopSize = 1
    ,tableBorderRowSize = 1
)

dbHeader <- dashboardHeaderPlus(title = tagList(
                                        a(href = "javascript:void(window.open('https://google.com', '_blank'))",
                                                         tags$img(src='MortalityViz.png', class = 'logo-lg',
                                                                  style = "float: center",height='45x',width='160px')),
                                        img(class = "logo-mini", src = "https://image.flaticon.com/icons/svg/204/204074.svg")),
                                tags$li(a(href = "javascript:void(window.open('https://github.com/bhsu4', '_blank'))",
                                          icon("github", "fa-1.5x"),
                                          title = "Visit my Github"),
                                          class = "dropdown", 
                                          style="color: #000; background-color: #b3b3b3; 
                                                      font-size:135% ;"), titleWidth = 200
                            )

flipBox2 <- function(..., back_content, id, front_title = NULL, back_title = NULL, 
                     front_btn_text = "More", back_btn_text = "Back to main", 
                     header_img = NULL, main_img = NULL, width = 6, height = 500) {
    
    if (is.null(id)) stop("card id cannot be null and must be unique")
    
    flipBoxTag <- shiny::tags$div(
        class = paste0("col sm-", width),
        shiny::tags$div(
            class = "rotate-container",
            style = paste("height: ", height , "px;", sep = ""),
            # Front
            shiny::tags$div(
                class = paste0("card card-front-", id , " text-center"),
                style = "background-color: #ffffff;",
                
                shiny::tags$div(
                    style = paste("height: ", 0.85*height , "px;", sep = ""), #front button
                    # background
                    shiny::tags$div(class = paste0("card-background-", id)),
                    shiny::tags$div(
                        class = "card-block",
                        shiny::tags$img(
                            class = "avatar",
                            src = main_img,
                            alt = "Avatar", 
                            style = "height: 100px;"
                        ),
                        shiny::tags$h3(class = "card-title", front_title),
                        shiny::tags$p(...)
                    ),
                ),
                shiny::tags$button(
                    id = paste0("btn-", id, "-front"),
                    class = "btn btn-primary btn-rotate",
                    shiny::tags$i(class = "fa fa-long-arrow-right"), 
                    front_btn_text      
                )
                
            ),
            # back
            
            # back
            shiny::tags$div(
                class = paste0("card card-back-", id , " text-center"),
                style = "background-color: #ffffff;",
                shiny::tags$div(
                    style = paste("height: ", 0.85*height , "px;", sep = ""), #back button
                    shiny::br(),
                    shiny::tags$div(
                        class = "card-header",
                        shiny::tags$p(
                            shiny::h4(back_title)
                        )
                    ),
                    shiny::hr(),
                    shiny::tags$div(
                        class = "card-block",
                        shiny::tags$p(back_content), 
                        
                    )
                ),
                shiny::tags$button(
                    id = paste0("btn-", id, "-back"),
                    class = "btn btn-primary btn-rotate",
                    shiny::tags$i(class = "fa fa-long-arrow-left"), 
                    back_btn_text      
                )
            )
        )
    )
    
    shiny::tagList(
        shiny::singleton(
            shiny::tags$head(
                # CSS
                shiny::tags$style(
                    shiny::HTML(
                        paste0(
                            "/* Card styles for rotation */
              .rotate-container {
                position: relative;
               }
               .rotate-container .card-front-", id, ", .rotate-container .card-back-", id," {
                width: 100%;
                height: 100%;
                -webkit-transform: perspective(600px) rotateY(0deg);
                transform: perspective(600px) rotateY(0deg);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                transition: all 0.5s linear 0s;
               }
               .rotate-container .card-back-", id, " {
                -webkit-transform: perspective(1600px) rotateY(180deg);
                transform: perspective(1600px) rotateY(180deg);
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
               }
               .rotate-container .rotate-card-front-", id, " {
                -webkit-transform: perspective(1600px) rotateY(-180deg);
                transform: perspective(1600px) rotateY(-180deg);
               }
               .rotate-container .rotate-card-back-", id, " {
                -webkit-transform: perspective(1600px) rotateY(0deg);
                transform: perspective(1600px) rotateY(0deg);
               }
               
               /* Modified card styles */
               .card {
                box-shadow: 0 8px 6px -6px rgba(0, 0, 0, 0.5);
               }
               .card .card-header p {
                margin: 0;
               }
               
               .card .card-background-", id, " {
                background: url('", header_img, "');
                height: 8em;
                background-position: center center;
                background-size: cover;
               }
               .card .avatar {
                max-width: 6em;
                max-height: 6em;
                margin-top: -4em;
                margin-bottom: 1em;
                border: 4px solid white;
                border-radius: 50%;
                background: radial-gradient(#e3e3e3, #329A7C, #109381);
               }
               .card .btn {
                margin-bottom: 1em;
                cursor: pointer;
               }
               .card .social-links li {
                margin: 0.5em;
               }
               .card .social-links a {
                font-size: 1.5em;
               }
               " 
                        )
                    )
                ),
                # Javascript
                shiny::tags$script(
                    shiny::HTML(
                        paste0(
                            "$(function() {
                // For card rotation
                $('#btn-", id,"-front').click(function(){
                  $('.card-front-", id,"').addClass(' rotate-card-front-", id, "');
                  $('.card-back-", id,"').addClass(' rotate-card-back-", id, "');
                });
                $('#btn-", id,"-back').click(function(){
                  $('.card-front-", id,"').removeClass(' rotate-card-front-", id, "');
                  $('.card-back-", id,"').removeClass(' rotate-card-back-", id, "');
                });
              });
              "
                        )
                    )
                )
            )
        ),
        flipBoxTag
    )
}


ui = dashboardPagePlus(
    
    title = "Mortality Analysis Calculator",
    footer = dashboardFooter(
        left_text = HTML(paste0("<script>", "var today = new Date();", "var yyyy = today.getFullYear();", "</script>", 
                                "<p style = 'text-align: center;'><medium> <a href='https://www.soa.org' target='_blank'> &copy; Society of Actuaries </a> </medium></p>"))
    ),
    dashboardHeader(
        title = HTML(glue::glue(
            '<span class="logo-mini">{"<strong>mac</strong>"}</span>
             <span class="logo-lg">{""}</span>'
        )), titleWidth = 200, 
        tags$li(a(href = "javascript:void(window.open('https://github.com/bhsu4', '_blank'))",
                  icon("github", "fa-1.5x"),
                  title = "Visit my Github"),
                class = "dropdown", 
                style="color: #000; background-color: #b3b3b3; font-size:135% ;")
    ),
    # Dashboard Page Setup ----------------------------------------------------
    #dbHeader,
    #dashboardHeader(
    ### changing logo
    # title = logo_blue_gradient),
    
    # Dashboard Sidebar -------------------------------------------------------
    dashboardSidebar(
        width = 200,
        sidebarUserPanel("",
                         subtitle = a(href = "tab_home", HTML("<p style = 'font-size: 14px'>Welcome to MAC!</p>")),
                         # Image file should be in www/ subdir
                         image = "mushu.jpg"
        ), tags$br(),
        sidebarMenu(id = "tabs_all",
            menuItem("Home", tabName = "tab_home", icon = icon("home")), 
            menuItem("Decomposition", #tabName = "tab_le", 
                     icon = icon("desktop"), startExpanded = TRUE,
                     menuSubItem("Overview", tabName = "tab_le", icon = icon("clipboard-list")),
                     menuSubItem("By Age", tabName = "DecAge", icon = icon("chevron-right")), #icon("hand-holding-heart")),
                     menuSubItem("By Age/COD", tabName = "DecAgeCOD", icon = icon("chevron-right"))), #icon("hand-holding-usd"))), #, "tab_le"),
            menuItem("Explore", tabName = "tab_explore", icon = icon("compass")), 
            menuItem("Documentation", tabName = "tab_docu", icon = icon("book")), 
            menuItem("Community", tabName = "tab_community", icon = icon("users")),
            menuItem("Latest News", tabName = "tab_news", icon = icon("file-alt")),
            menuItem("Instructions", tabName = "tab_instructions", icon = icon("book")),
            menuItem("FAQ", tabName = "tab_qa", icon = icon("question-circle")) #, 
            #HTML(paste0(
            #    "<br><br><br><br><br><br><br><br><br>",
            #    "<table style='margin-left:auto; margin-right:auto;'>",
            ##    "<tr>",
            #    "<td style='padding: 5px;'><a href='https://www.facebook.com/SocietyofActuaries' target='_blank'><i class='fab fa-facebook-square fa-lg'></i></a></td>",
            #    "<td style='padding: 5px;'><a href='https://www.twitter.com/soactuaries' target='_blank'><i class='fab fa-twitter fa-lg'></i></a></td>",
            #    "<td style='padding: 5px;'><a href='https://www.instagram.com/soactuaries' target='_blank'><i class='fab fa-instagram fa-lg'></i></a></td>",
            #    "</tr>",
            #   "</table>"
            #    ),
            #    HTML(paste0(
            #        "<script>",
            #        "var today = new Date();",
            #        "var yyyy = today.getFullYear();",
            #        "</script>",
            #        "<p style = 'text-align: center;'><small>&copy; - <a href='https://benjaminhsu.netlify.com' target='_blank'>Benjamin Hsu</a> - </small></p>")
            #    ))
           
        )
    ),
    
    # Dashboard Body ----------------------------------------------------------
    dashboardBody(
    
        tags$script(HTML("$('body').addClass('sidebar-mini');")),
        tags$style(HTML('body {font-family:"Roboto Condensed", sans-serif}')),
        theme_custom,
        
        #favicon
        tags$head(tags$link(rel = "shortcut icon", 
                            href = "https://www.columbia.edu/content/themes/custom/columbia/favicon-crown.png"), 
        ), 
      
        
    tabItems(
        # About - tab_introduction of the web application -------------------------------------------------------
        tabItem(
            "tab_home", HTML(paste0('<nobr><b><h3>Mortality Analysis Calculator v.1.0.2</h3></b></nobr>')), hr(),
            fluidPage(
                    box(
                        title = "", style="position:absolute;width:100%;padding-bottom:62.75%;",
                        status = "success",
                        width = 4, height = 600,
                        column(width = 12, align = "center",
                                        img(src = "compass-icon.png", width=100),
                        HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black;' >Explore</p></h2></b>",
                        "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                        Guided learning with explanation on the depths of mortality decomposition analysis. 
                        Follow step by step process to explore the technical details of mortality decomposition. </p>")), 
                        div(style="display:inline-block; width:100%; text-align: center;", 
                          actionButton(inputId='explore_more', label="Let's Explore", icon = icon("plus")))
                        )
                    ) , 
                    box(
                        title = "", style="position:absolute;width:100%;padding-bottom:62.75%;",
                        status = "primary",
                        width = 4, height = 600,
                        column(width = 12, align = "center",
                               img(src = "book-icon.png", width=100),
                               HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black ;' >User Manual</p></h2></b>",
                               "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                               Find instructions and a walkthrough of how to navigate the Mortality Analysis Calculator. 
                               Work your way towards understanding decomposition analysis inside and out. </p>")), 
                               div(style="display:inline-block; width:100%; text-align: center;", 
                                   actionButton(inputId='instruc_more', label="See Instructions", icon = icon("plus")))
                        )
                    ) , 
                    box(
                        title = "", style="position:relative;width:100%;padding-bottom:62.75%;",
                        status = "warning",
                        width = 4, height = 600,
                        column(width = 12, align = "center",
                               img(src = "users-icon.png", width=100),
                               HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black; '>FAQ</p></h2></b>",
                               "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                               Browse through questions answered by our community of actuaries and developers. 
                               See where you can get more information on mortality decomposition analysis.</p>")), 
                               div(style="display:inline-block; width:100%; text-align: center;", 
                                   actionButton(inputId='qa_more', label="Learn More", icon = icon("plus")))
                        )
                    ), 
                    mainPanel(
                        title = "", 
                        width = 12, 
                        slickROutput("slickr", width = "90%", height = "150px")
                    ), 
                    box(
                        title = "", 
                        status = "danger",
                        width = 8, height = 475,
                        column(width = 12, align = "center",
                               HTML(paste0("<b><h2><p style = 'text-align: left ; color: black; margin-top: -25px; margin-bottom: 25px ;'>Learn About Actuarial Science</p></h2></b>"))),
                        column(width = 4, align = "left", 
                               HTML(paste0("<b><h3><p style = 'text-align: left ; color: grey; font-size: 21px;'>Career & Learning</p></h3></b><br>")),
                               HTML(paste0("<h4><a href='https://soa.org', target='_blank'> Society of Actuaries </a><h4>", "<br>")),
                               HTML(paste0("<h4><a href='https://sps.columbia.edu/academics/masters/actuarial-science', target='_blank'> Columbia University Masters in Actuarial Science </a><h4>"))
                        ),
                        column(width = 4, align = "left", 
                               HTML(paste0("<b><h3><p style = 'text-align: left ; color: grey ; font-size: 21px;' >Professional Development</p></h3></b><br>")),
                               HTML(paste0("<h4><a href='https://www.soa.org/prof-dev/pdopportunities/?epsremainingpath=/&filters=Opportunity_Type[ECOURSE]&pagesize=All&view=', target='_blank'> SOA E-Course</a><h4>")) 
                        ),
                        column(width = 4, align = "left", 
                               HTML(paste0("<b><h3><p style = 'text-align: left ; color: grey; font-size: 21px;'>Additional Resources</p></h3></b><br>")),
                               HTML(paste0("<h4><a href='https://pathways.soa.org/' target='_blank'> Educational Pathways</a><h4>", "<br>")), 
                               HTML(paste0("<h4><a href='https://beanactuary.org', target='_blank'> Be An Actuary</a><h4>", "<br>")), 
                               HTML(paste0("<h4><a href='https://www.soa.org/resources/soa-explorer/', target='_blank'> SOA Explorer</a><h4>"))
                        )
                        
                    ), 
                    box(
                        title = "", 
                        status = "danger",
                        width = 4, height = 475,
                        column(width = 12, align = "center",
                               HTML(paste0("<b><h2><p style = 'text-align: left ; color: black; margin-top: -25px; margin-bottom: 25px ; '; >Support Us</p></h2></b>"))),
                        column(width = 12, align = "left", 
                               HTML(paste0("<b><h3><p style = 'text-align: left ; color: grey; font-size: 21px; ';>Society of Actuaries</p></h3></b><br>")),
                               column(width = 12, align = "center", 
                                   socialButton(url = "https://www.facebook.com/SocietyofActuaries", type = "facebook"), 
                                   socialButton(url = "https://www.twitter.com/soactuaries", type = "twitter"),
                                   socialButton(url = "https://www.instagram.com/soactuaries", type = "instagram"), hr(),
                               )
                        ), 
                        column(width = 12, align = "left", 
                               HTML(paste0("<b><h3><p style = 'text-align: left ; color: grey; font-size: 21px;' >Columbia University</p></h3></b><br>")),
                               column(width = 12, align = "center", 
                                      socialButton(url = "https://www.facebook.com/columbia", type = "facebook"), 
                                      socialButton(url = "https://www.linkedin.com/in/columbia-university-ms-in-actuarial-science-program-29512515b/", type = "linkedin"), 
                                      socialButton(url = "https://www.instagram.com/columbiaascu/", type = "instagram")
                               )
                        )
                    )
            )
        ),
        
        # About - tab_introduction of the web application -------------------------------------------------------
        tabItem(
            "tab_explore", 
            fluidRow(
                column(width = 12,
                    column(width = 8, 
                    mainPanel(title = "", width = NULL,
                        HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px;'>Mortality Analysis Calculator</p></h2></b>", 
                                    "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px; '>
                                    The Mortality Analysis Calculator (MAC) is a tool to analyze mortality information from the
                                    Human Mortality Database (HMD) and Cause of Death Database. Users will directly interact with 
                                    our flexible interface and receive results quickly. The visualizations provide key information 
                                    presented in a simplified and easy to understand way of looking at decomposition analysis. <h3></p>"), 
                             paste0("<h3><p style = 'text-align: left ; color: grey ; font-size: 20px;'>
                                    As we navigate into the future, emerging technology and innovations continue to play a major 
                                    role in the extraordinary decline in human mortality. Improvements in economic and social conditions
                                    have contributed to the increased health status of the population. To quantify such dynamics, 
                                    techniques such as mortality decomposition analysis allow us to determine mortality contributions. 
                                    This will provide more information about our population of interest.<h3></p>"))
                    ), 
                    mainPanel(title = "", width = NULL,
                        HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px; '>Decomposition of Mortality</p></h2></b>", 
                                    "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px; '>
                                    Mortality decomposition is a tool to explain the underlying changes in its components. 
                                    The central aim is to attribute the difference in an aggregate index to better examine specific
                                    contributions. <h3></p><br>"))
                    )
                ), 
                column(width = 3, 
                       align = "center", img(src = "four-icon.png", width=300)),
            ),
            column(width = 12, 
                column(width = 3, 
                    flipBox2(id = 1, main_img = "number1-icon.svg", height = 700,
                          front_title = HTML(paste0("<p>Life Expectancy</p>")), back_title = "Functionality in MAC",
                               HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                          We've seen an increase in life expectancy since the second half of the twentieth
                                          century driven by underlying mortality improvement. Learn how life expectancy
                                          is changing amongst the population of interest. </p>")) 
                          , 
                          back_content = tagList(
                               HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                               <b>Decomposition by Age:</b> The user can compute the effects attributable to each relevant age group(s). <br></br>
                               <b>Decomposition by Age/COD:</b> The user can compute the effects attributable to selected age group.</p>")
                          ))
                    )
                ),
                column(width = 3, 
                    flipBox2(id = 2, main_img = "number2-icon.svg", height = 700,
                         front_title = "Life Preparancy", back_title = "Functionality in MAC",
                                HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                            There is a growing need to promote retirement preparedness that goes beyond looking 
                                            at the average ages that might be obtained across the population. Learn more about life
                                            preparancy and its historical evolution. </p>")) 
                         , 
                         back_content = tagList(
                                   HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                   <b>Decomposition by Age:</b> The user can observe the change in life preparancy, and compute the 
                                   effects attributable to each relevant age group(s). <br></br>
                                   <b>Decomposition by Age/COD:</b> The user can compute the effects attributable to selected age group.</p>")
                        ))
                    )
                ),
                column(width = 3, 
                    flipBox2(id = 3, main_img = "number3-icon.svg", height = 700,
                        front_title = "Gender", back_title = "Functionality in MAC", 
                               HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px;font-size: 17px'>
                                   Gender is the focal point of all analysis of mortality. Demographers study gender to assess 
                                   and gain information on a population. Take a deeper dive into the gender gap, and better 
                                   understand gender relations. </p>")) 
                        , 
                        back_content = tagList(
                                   HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                   <b>Decomposition by Age:</b> The user can observe the gender gap in life expectancy, and compute the 
                                   effects attributable to each relevant age group(s). <br></br>
                                   <b>Decomposition by Age/COD:</b> The user can compute the gender gap effects attributable to selected age group.</p>")
                        ))
                     )
                ),
                column(width = 3, 
                    flipBox2(id = 4, main_img = "number4-icon.svg", height = 700,
                        front_title = "Cause of Death", back_title = "Functionality in MAC",
                                HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                     Cause-specific mortality provide relevant information about the health status of the population.
                                     Track the leading causes of death, and identify challenges and interventions needed 
                                     to improve the health of the population.</p>"))
                        , 
                        back_content = tagList(
                                   HTML(paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                   <b>Decomposition by Age/COD:</b> The user can compute death rate for each cause-specific mortality 
                                   to relevant age group(s).</p>")
                        ))
                    )
                )
            ), 
            column(width = 12, style = "padding-top:20px;",
                   box(title = "", width = 6, height = 300,
                                    HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px; margin-top: -25px; margin-bottom: 25px ; '>Get Started Now!</p></h2></b>", 
                                                "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px'>
                                    Explore the Mortality Analysis Calculator, and start your mortality decomposition journey!
                                    Take a dive into decomposition analysis by age or by age and cause-of-death. Spend your
                                    time learning more about how the population's health status have changed. <h3></p>")),
                                    div(style="display:inline-block; width:100%; text-align: center; font-size: 40px", 
                                        actionButton(inputId='start_more', label="Get Started"))
                   ),
                   box(title = "", width = 6, height = 300,
                                    HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px; margin-top: -25px; margin-bottom: 25px ; '>Shape Future Releases</p></h2></b>", 
                                                "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px'>
                                    Browse frequently asked questions and look at the responses answered by our team.
                                    Share your ideas about mortality decomposition and web development with the community. <h3></p>")), 
                                    div(style="display:inline-block; width:100%; text-align: center;", 
                                        actionButton(inputId='faq_more', label="Read FAQ"))
                   )
            )
        )),
        tabItem(
            "tab_docu", 
            fluidRow(
                column(width = 12,
                   column(width = 8, 
                      mainPanel(title = "", width = NULL,
                                HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px; '>Documentation for MAC</p></h2></b>", 
                                            "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px;'>
                                            Mortality decomposition is a tool to explain the underlying changes in its components. 
                                            The central aim is to attribute the difference in an aggregate index to better examine specific contributions. 
                                            For the MAC documentation, life expectancy will be used for simplicity. In addition, decomposing mortality
                                            has different formulations published by 
                                            <a href='https://scholar.google.com/scholar?q=Andreev%2C%20Evgeny%20M.%20%281982%29%2C%20Method%20komponent%20v%20analize%20prichin%20smerti.%20%28Component%20method%20applied%20to%20life%20expectancy%20analysis%29.%20Vestnik%20Statistiki%20%28Herald%20of%20Statistics%29%2Cn%C2%B0%209%2C%20pp.%2042%E2%80%9347.%20%28In%20Russian%29.' target='_blank'> Andreev 1982</a>, 
                                            <a href='https://www.jstor.org/stable/1532986?seq=1' target='_blank'> Pressat 1985</a>, 
                                            <a href='https://link.springer.com/article/10.2307/2061029' target='_blank'> Arriaga 1984</a>.
                                            A quick introduction will be provided in the subsequent section to clarify on this concept. <h3></p>"))
                      ), 
                      mainPanel(title = "", width = NULL,
                                HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px;'>Introduction to Decomposition</p></h2></b>", 
                                            "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px; '>
                                            Given our aggregate index of life expectancy, we can decompose contributions by age
                                            groups into what Arriaga refers to as 'direct' and 'indirect' effects of mortality change.
                                            Direct Effects are defined as the change in life expectancy within a particular 
                                            age group, due to underlying changes in the mortality within that age group. The specific
                                            calculations take the proportion of survivors at each age group and multiply it by the
                                            temporary life expectancy from that age group to the subsequent age interval. Indirect Effects 
                                            are defined as the change in life expectancy to an age group due to changes in another age
                                            interval. This will take into account the impact of the number of survivors from one age interval 
                                            on subsequent age intervals. Lastly, interactive effect consists of any outside effects that result
                                            in changes in life expectancy, not explained by the age group. The total of the direct, indirect, 
                                            and interactive effects will be equivalent to the total effect, or in this case, the total change
                                            in the life expectancy. <h3></p><br>"))
                      )
                   )
                ),
                column(width = 10, align = "center", img(src = "decomp.jpg", width = 800)),
                column(width = 12,
                   column(width = 8, 
                      mainPanel(title = "", width = NULL,
                                HTML(paste0("<b><h1><p style = 'text-align: left ; color: black ; font-size: 25px;'>Stepwise Decomposition</p></h2></b>", 
                                            "<h3><p style = 'text-align: left ; color: grey ; font-size: 20px;'>
                                            The following illustration above was taken from the 
                                            <a href='https://www.springer.com/gp/book/9783030376666' target='_blank'><em><b> 
                                            International Handbook of Health Expectancies (Jagger, Crimmins, Saito, de Carvallho Yokota, 
                                            Van Oyen, Robine) </b></em></a>."), HTML("<br></br>"),
                                     paste0("<a href='https://www.demographic-research.org/volumes/vol7/14/default.htm' target='_blank'> Andreev 2002</a> 
                                            proposed a step-wise decomposition that built on Arriaga's methodology.
                                            Given that decomposition can be generalized into direct, indirect, and interactive effects, 
                                            in which the sum is equivalent to the aggregate index. We are able to estimate contributions 
                                            through the step-wise decomposition. <h3></p>"),
                                     paste0("<h3><p style = 'text-align: left ; color: grey ; font-size: 20px;'>
                                            In the illustration, there are two populations, A, and B with ages 0, 1, 2, 3. 
                                            The age-specific death rates are provided by the m-vector, and life expectancy 
                                            at birth is defined as e0. In step 2, the change in the life expectancy between 
                                            population A and B is calculated by taking the difference in the life expectancy 
                                            at birth. The age-specific death rate at age 0 for population B is replaced by that 
                                            of population A's in step 3. This will allow us to find the contribution of age 0 
                                            to the change in life expectancy. In steps 4, 5, 6, the very same replacements 
                                            are performed on ages 1, 2, and 3. Thus, the contribution for each age to life expectancy
                                            can be calculated. Meanwhile, the sum of the contributions are equivalent to the 
                                            total change in life expectancy.<h3></p><br>"))
                     )
                  )
               )
            )
        ),
        
        # About - tab_introduction of the web application -------------------------------------------------------
        tabItem(
            "tab_news", 
            fluidRow(
                box(
                    title = HTML("<h4 style = 'text-align: center;'><b> Latest Industry News </b></p><hr>"),
                    status = "primary",
                    width = 6,
                    userPost(
                        id = 1,
                        src = "mushu.jpg",
                        author = "The SOA Explores the Role of Actuaries in the Face of the COVID-19 Situation",
                        description = "R. Dale Hall",
                        "R. Dale Hall, FSA, CERA, MAAA, CFA managing director of Research for the Society of Actuaries (SOA) explains 
                        the many roles actuaries can have as COVID-19 spreads around the world.", HTML("</br></br>"),
                        "Schaumburg, Ill., March 10, 2020 - The past few weeks have seen the emergence and spread of a novel coronavirus named 
                        'SARS-CoV2' that causes the respiratory disease named 'coronavirus disease 2019' (COVID-19).  While original detection 
                        occurred in China, the U.S. Centers for Disease Control and Prevention (CDC) note that the disease is now detected in 60 
                        locations internationally, including the United States.", HTML("</br>"),
                        div(style="display:inline-block; width:170%; text-align: center;", actionButton(inputId='ab1', label="Learn More", 
                                            icon = icon("plus"), 
                                            onclick ="window.open('https://www.soa.org/resources/announcements/press-releases/2020/2020-covid-19-situation/', '_blank')"))
                    ),
                    userPost(
                        id = 2,
                        src = "mushu.jpg",
                        author = "Expanding the Human Mortality Database to Include Cause-of-Death Information",
                        description = "Society of Actuaries",
                        "The Human Mortality Database is a unique open-access collection of detailed mortality and population data for 38 
                        countries with complete and reliable vital registration and census data. The HMD currently covers the United States, 
                        almost all of Europe, including countries of the former U.S.S.R., Japan, Australia and other mostly high-income 
                        countries with rapidly aging populations. The Human Mortality Database (HMD) contains calculations of death rates 
                        and life tables for national populations (countries or areas), as well as the original input data used to construct 
                        these tables and an extensive documentation. This report overviews the development and completion of the HMD data 
                        series down to a cause of death level for an initial set of eight populations: Canada, Czech Republic, England and 
                        Wales, France, Japan, Norway, Sweden, and the United States.", HTML("</br></br>"), 
                        "The HMD web pages with the cause-of-death information are under development. Click here to go to the prototype 
                        for the cause-of-death web pages, and use the username, 'hmdcod', and password, 'magali', to log in."
                    ),
                    userPost(
                        id = 3,
                        src = "mushu.jpg",
                        author = "Join the 2020 Health Meeting Webcast Series!",
                        description = "Society of Actuaries",
                        "The 2020 Health Meeting Webcast Series features ten days of ten Health tracks, allowing attendees 
                        to create their own Health Meeting experience by mixing and matching which days and webcasts fit their 
                        professional development needs.", HTML("</br>"),
                        div(style="display:inline-block; width:170%; text-align: center;", 
                            actionButton(inputId='ab2', label="Learn More", icon = icon("plus"), 
                                         onclick ="window.open('https://www.soa.org/prof-dev/pdopportunities/?filters=Topic[T_HLTHWC]&view=grid', '_blank')")), 
                        HTML("</br></br>"),
                        userPostMedia(src = "health-webcast.jpg")
                    )
                ),
                box(
                    title = HTML("<h4 style = 'text-align: center;'><b> Latest Updates on Web Application </b></p><hr>"),
                    status = "warning",
                    width = 6,
                    userPost(
                        id = 99,
                        src = "me.png",
                        author = HTML(paste0("<b>Mortality Analysis Calculator v1.0.1</b>")), 
                        description = "Benjamin Hsu, 8/1/2020",
                        HTML(paste0("The first update v.1.0.1 to the MAC are addressed below. <br>
                                     <ul><li>Other country inclusions, and reactive conditional time intervals</li>
                                         <li>Validation of decomposition results</li>
                                         <li>Help file in decomposition needing update</li>
                                         <li>Formatting of boxes in decomposition</li>
                                         <li>Font consistency in MAC </li><ul>"))
                    ),
                    userPost(
                        id = 100,
                        src = "me.png",
                        author = HTML(paste0("<b>Mortality Analysis Calculator v1.0.0</b>")),
                        description = "Benjamin Hsu, 7/29/2020",
                        HTML(paste0("The first launched version of the MAC will consist of mortality decomposition analysis 
                                     for both age as well as age and cause-of-death. We are excited to share this with our 
                                     users, and hope that you all enjoy it as much as we have enjoyed developing the web application."))
                    )
                    
                )
            )
        ),
        # decomp by age - tab_life exp -------------------------------------------------------
        tabItem(
            "tab_le", 
                # overview start -----------------------------------------------
                HTML(paste0("<nobr><b><h3>Overview of Decomposition Analysis</h3></b></nobr>")), hr(),
           fluidRow(
                box(
                    title = "", 
                    status = "warning",
                    width = 4, height = 1200,
                    column(width = 12, align = "center",
                           img(src = "heart-icon.png", width=100),
                           HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black'>Life Expectancy</p></h2></b>",
                                       "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                        Life expectancy is the average experience of the population subset. (e.g. Half of the population 
                                        subset are expected to lie longer than life expectancy, and half are not expected to survive to
                                        life expectancy) </p>"), 
                                paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                        Life expectancy is an integral part of how insurance companies are able to determine 
                                        longevity predictions. It provides a general estimation of the number of years a person 
                                        will survive, and influences much of retirement and estate planning. Though, not a definitive 
                                        number that captures individual lifestyle choices, family history, and other factors, 
                                        life expectancy is still heavily relied upon in the actuarial industry. </p>"))
                    )
                ),
                box(
                    title = "", 
                    status = "danger",
                    width = 4, height = 1200,
                    column(width = 12, align = "center",
                           img(src = "money-icon.png", width=100),
                           HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black'>Life Preparancy</p></h2></b>",
                                       "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                        A life preparancy age might be commonly defined as the age at which nth percentile of a population 
                                        at which an age x will survive to. (e.g. The age to which 10 percent of a population that has 
                                        already reached age 65 is expected to live in the future) </p>")), 
                           blockQuote("[There is] a growing need for the actuarial profession around the world to
                               promote retirement plans that include lifetime income options....
                               Longevity risk, however, is a much more delicate issue than simply noting the 
                               average ages that might be obtained across a population. First, actuaries need 
                               to change the public's vocabulary to switch from 'expectancy from birth' 
                               to 'retirement preparedness.'",     
                           HTML("<br></br><p style = text-align:right>-<b>Dale Hall, Managing Director of Research at the SOA </p></b>"))
                    )         
                ),
                box(
                    title = "", 
                    status = "success",
                    width = 4, height = 1200,
                    column(width = 12, align = "center",
                           img(src = "chapter-icon.png", width=100),
                           HTML(paste0("<br>" ,"<b><h2><p style = 'text-align: center ; color: black'>Cause of Death</p></h2></b>",
                                       "<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                        Cause of death provide an additional dimension to our analysis by looking deeper
                                        at the cause-specific mortality rates. (e.g. Chapters may include: cancer, 
                                        respiratory, pregnancy/childbirth, etc.) </p>"), 
                               paste0("<p style = 'text-align: center; line-height: 25px; vertical-align: center; padding: 15px 35px; font-size: 17px'>
                                      Cause-specific mortality provide essential information about mortality trends.
                                      Analysis by cause of death categories allow actuaries to design products that may accommodate  
                                      for these different needs. Past historical information can provide insight on latest mortality
                                      trends to ensure the health status of the population. </p>"))
                    ) 
                )
            )
        ),
        tabItem(
            "DecAge", 
            fluidRow(
                column(width = 12,
                           boxPlus(title = "Choose Parameters", closable = FALSE, width = NULL, 
                                   status = "danger", collapsible = TRUE, solidHeader = TRUE, 
                                   enable_dropdown = TRUE, dropdown_icon = "sticky-note", 
                                   dropdown_menu = dropdownItemList(dropdownItem(url = "https://www.demographic-research.org/volumes/vol7/14/7-14.pdf", name = "Decomposition Source"), 
                                                                    dropdownDivider()
                                                                    ), 
                           fluidRow(
                               column(width = 3,
                                   fluidRow(
                                       column(width = 10,
                                        selectInput("heatCountry", "Selected Country", c(Choose = ""), selectize = TRUE)
                                        ), 
                                       column(width = 2, 
                                       actionButton(
                                           inputId = "heatQA",
                                           label = "",
                                           icon = icon("question-circle"),
                                           style="color: #fff; background-color: #b3b3b3; 
                                                  border-color: #b3b3b3; padding:2px; font-size:78% ; 
                                                  width: 20px; height: 20px"
                                       ))
                                       
                                   ),
                                   fluidRow(
                                       column(width = 12,
                                          checkboxGroupButtons(
                                              inputId = "heatGender", label = "Gender", 
                                              choices = c("Male", "Female"), selected = "Male", 
                                              justified = TRUE, status = "primary"))
                                   )
                               ), 
                              column(width = 9, 
                                  # Input: Specification of range within an interval ----
                                   wellPanel( 
                                       uiOutput("addControls")
                                   ) # wellPanel
                              ) # column
                           
                       

                         ) #fluidrow
                         
                       )
                     ), 
                column(width = 12,
                       
                       tabBox(width = NULL, title = tagList(shiny::icon("calculator"), "By Age"), 
                              tabPanel(title = "Change in Life Expectancy", id = "tabset1", 
                                 tags$br(),             
                                   fluidRow(

                                        column(width = 6,
                                              plotlyOutput("BarplotLE", height = 300)
                                        )
                                        , 
                                       column(width = 6, 
                                                plotlyOutput("BarplotLE_specific", height = 300)
                                       )
                                           
                                   ), HTML('<hr style = "color: #ecf2f7;">'), tags$br(), 
                                  fluidRow(
                                       column(width = 12, 
                                            withSpinner(plotlyOutput("HeatMap", height = 600), proxy.height = "20px")
                                       )
                                   )
                              ),
                              tabPanel(title = "Change in Life Preparancy",
                                   tags$br(),
                                   fluidRow(
                                       column(width = 10,
                                              withSpinner(plotlyOutput("LineLP", height = 400)), 
                                       ), 
                                       column(width = 2, 
                                              numericInput("z", "Percentile", value = 90, min = 0, max = 100, step = 5)
                                              )
                                    
                                    ), HTML('<hr style = "color: #ecf2f7;">'), tags$br(), 
                                   fluidRow(
                                       column(width = 12, 
                                              withSpinner(plotlyOutput("HeatMapLP", height = 600), proxy.height = "20px")
                                       )
                                   )
                              ),
                              tabPanel(title = "Contribution to Gender",
                                       tags$br(),
                                       fluidRow(
                                           column(width = 12,
                                                  withSpinner(plotlyOutput("GapAge", height = 600)) 
                                           )
                                       ), 
                              )
                       )
                )
            )

        ),
    ##################### -- Start of Decomp. Age + COD -- #########################
        tabItem(
            "DecAgeCOD", 
             fluidRow(   
                column(width = 12,
                       boxPlus(title = "Choose Parameters", closable = FALSE, width = NULL, 
                               status = "danger", collapsible = TRUE, solidHeader = TRUE, 
                               enable_dropdown = TRUE, dropdown_icon = "sticky-note", 
                               dropdown_menu = dropdownItemList(dropdownItem(url = "https://www.demographic-research.org/volumes/vol7/14/7-14.pdf", name = "Decomposition Source"), 
                                                                dropdownDivider()
                        ),
                       fluidRow(
                           column(width = 3,
                                  fluidRow(
                                      column(width = 6,
                                             selectInput("CODCountry", "Selected Country", c(Choose = ""), selectize = TRUE)
                                      ), 
                                      column(width = 4, 
                                             numericInput("CODAge", "Input Age", value = 0, min = 0, max = 105, step = 5)
                                      ),
                                      column(width = 2, 
                                             actionButton(
                                                 inputId = "CODQA",
                                                 label = "",
                                                 icon = icon("question-circle"),
                                                 style="color: #fff; background-color: #b3b3b3; 
                                          border-color: #b3b3b3; padding:2px; font-size:78% ; 
                                          width: 20px; height: 20px"
                                             ))
                                      
                                  ),
                                  fluidRow(
                                      column(width = 12,
                                             checkboxGroupButtons(
                                                 inputId = "CODGender", label = "Gender", 
                                                 choices = c("Male", "Female"), selected = "Male", 
                                                 justified = TRUE, status = "primary")
                                      )
                                 )
                           ), 
                           column(width = 9, 
                                  # Input: Specification of range within an interval ----
                                  wellPanel( 
                                      uiOutput("moreControls")
                                  ) # wellPanel
                           ) # column
                       ) #fluidrow
                   )
                )
            ),
            
            fluidRow(
                
                column(width = 12,
                       
                       tabBox(width = NULL, title = tagList(shiny::icon("hand-holding-heart"), "By Age/COD"), 
                                   tabPanel(title = "Cause of Death by Country", id = "tabset22", 
                                            tags$br(),
                                            fluidRow(
                                                column(width = 12,
                                                       withSpinner(plotlyOutput("Animate_MCBar", height = 800))
                                                )
                                            )
                                   ),
                                   tabPanel(title = "Change in Life Expectancy", id = "tabset33", 
                                            tags$br(),
                                            fluidRow(
                                                column(width = 6,
                                                       plotlyOutput("BarplotLE_AgeCOD", height = 300)
                                                ), 
                                                column(width = 6, 
                                                       plotlyOutput("BarplotLE_specificAgeCOD", height = 300)
                                                )
                                            ), HTML('<hr style = "color: #ecf2f7;">'), tags$br(), 
                                            fluidRow(
                                                column(width = 12, 
                                                       withSpinner(plotlyOutput("HeatMap_AgeCOD", height = 600), proxy.height = "20px")
                                                )
                                            )
                                   ), 
                                   tabPanel(title = "Change in Life Preparancy",
                                            tags$br(),
                                            fluidRow(
                                                column(width = 10,
                                                       withSpinner(plotlyOutput("HeatMapLP_COD", height = 600)), 
                                                ), 
                                                column(width = 2, 
                                                       numericInput("CODz", "Percentile", value = 90, min = 0, max = 100, step = 5)
                                                )
                                               
                                            )
                                  ),
                                  tabPanel(title = "Contribution to Gender",
                                           tags$br(),
                                           fluidRow(
                                               column(width = 12,
                                                      withSpinner(plotlyOutput("GapAgeCOD", height = 600)), 
                                               )
                                               
                                           )
                                  )
                       )
                )
                
                
                
                
            )
            
        ),
                    
        
        # About - tab_about ------------ introducing community, and contacts
        tabItem( 
            "tab_community",
            
            fluidRow(
                # About - About Me - start ------------------------------------------------
                widgetUserBox(
                    title = "Benjamin Hsu",
                    subtitle = "M.S. in Actuarial Science",
                    type = NULL,
                    width = 4, height = 450,
                    src = "me.png",
                    background = TRUE,
                    backgroundUrl = "wallpaper.jpg",
                    closable = FALSE, collapsible = FALSE,
                    HTML(paste0("<br>", "<h4><p style = 'text-align: center ; color: black'>Lead Developer</p></h4></b>")), hr(),
                    tags$strong("Hi! I'm Ben!"), 
                    HTML(paste0("Get in touch with me on LinkedIn (", tags$a(href = "https://www.linkedin.com/in/benjamin-hsu-10b33a97/", "Benjamin Hsu"), "),")),  
                    "online at", HTML(paste0(tags$a(href = "https://benjaminhsu.netlify.com", "benjaminhsu.com", target = "a()"), ",")), 
                    "or by email at", HTML(paste0("<a href = 'mailto:bh2722@columbia.edu', target='_blank'> bh2722@columbia.edu </a>")),
                    footer = "I am a Master of Science student in Actuarial Science at Columbia University. 
                             I graduated from the University of Rochester with a Bachelor's degree in Statistics 
                             with a Certificate in Actuarial Science. I like to work on projects with statistical 
                             and machine learning. You can find more of my work on my website, or get in touch with 
                             me via LinkedIn or my email above.")
            )
        ), 
        # Instructions Manual 
        tabItem( 
          "tab_instructions",
          
          boxPlus(
            title = HTML("<h4 style = 'text-align: center;'><b> User Manual </b></p><hr>"), 
            closable = FALSE, 
            width = NULL,
            status = "warning", 
            solidHeader = FALSE, 
            collapsible = FALSE,
            enable_dropdown = FALSE,
            fluidRow(
              column(width = 12, 
              a(HTML("<h5 style = 'text-align: left;'><b> Get Started </b></p>"), href = "#started"),
              "Before you start exploring the Mortality Analysis Calculator, we will get you acquainted with the inputs.", HTML("</br>"), 
              HTML("<br><ul><li>There are panels on the left for navigation around the Mortality Analysis Calculator. 
                                Decomposition analysis is split into two tabs: by age or by age and cause of death.</li>, 
                        <br><li>Each decomposition analysis consists of multiple tabs that will require inputs from the 
                                country, gender, and age of interest, along with a specific time frame we want to observe. These 
                                inputs will be introduced further below. </li><br></ul>"),
              
              a(HTML("<h5 style = 'text-align: left;'><b> Selecting Inputs </b></p>"), href = "#selectinputs"),
              h5("For both mortality decomposition by age and by age/cause of death, the graphs and plots will require inputs specifying 
                  a specific country, age group, gender, and historical time frame. The inputs box as shown below, will be on each decomposition 
                  page. These inputs will flow through to each tab for life expectancy, life preparancy, and gender. Please note that the only
                  difference between decomposition by age and by age/cause of death is the inclusion of input age. Any questions regarding 
                  the objectives of the tool can be found in the question mark box. Below you can familiarize yourself
                  to parameter setting without any results displaying. Please try to:"), 
              HTML("<br><ul><li>Select a country from a drop down menu</li>, 
                        <br><li>Type an age of interest into the box</li>
                        <br><li>Choose gender(s)</li>
                        <br><li>Use the slider to choose your historical time frame</li>
                        <br><li>Press the question mark box for more information on the objectives of the tool, and the analysis/exhibits</ul>"),
              HTML("</br>"), 
      
              boxPlus(title = "Choose Parameters", closable = FALSE, width = NULL, 
                     status = "danger", collapsible = TRUE, solidHeader = TRUE, 
                     enable_dropdown = TRUE, dropdown_icon = "sticky-note",
                     fluidRow(
                       column(width = 3,
                              fluidRow(
                                column(width = 6,
                                       selectInput("testCountry", "Selected Country", 
                                                   choices = c("Taiwan", "U.K.", "Scotland", "U.S.A", "Ukraine"), 
                                                   selectize = TRUE)
                                ), 
                                column(width = 4, 
                                       numericInput("testAge", "Input Age", value = 0, min = 0, max = 105, step = 5)
                                ),
                                column(width = 2, 
                                       actionButton(
                                         inputId = "TestQA",
                                         label = "",
                                         icon = icon("question-circle"),
                                         style="color: #fff; background-color: #b3b3b3; 
                                                border-color: #b3b3b3; padding:2px; font-size:78% ; 
                                                width: 20px; height: 20px")
                                )
                              ),
                              fluidRow(
                                column(width = 12,
                                       checkboxGroupButtons(
                                         inputId = "TestGender", label = "Gender", 
                                         choices = c("Male", "Female"), selected = "Male", 
                                         justified = TRUE, status = "primary")
                                )
                              )
                       ), 
                       column(width = 9, 
                              # Input: Specification of range within an interval ----
                              wellPanel( 
                                sliderInput("range_test",
                                            label = "Years Selected",
                                            min = 1950, max = 2009, value = c(1950, 2009), sep = "")
                              ) # wellPanel
                       ) # column
                   ) #fluidrow
               ), #boxplus
              a(HTML("<h5 style = 'text-align: left;'><b> Objectives </b></p>"), href = "#objective"),
              h5("Mortality decomposition is a tool to explain the underlying changes in its components. The central aim is to attribute 
                  the difference in an aggregate index to better examine specific contributions. Taking an aggregate index of life expectancy 
                  for example, we can decompose contributions by age groups into what 'direct' and 'indirect' effects of mortality 
                  change. Direct effects are defined as the change in life expectancy within a particular age group, due to underlying changes
                  in the mortality within that age group. Indirect effects are defined as the change in life expectancy to an age group due to 
                  changes in another age interval. This will take into account the impact of the number of survivors from one age interval on 
                  subsequent age intervals. Lastly, interactive effects consist of any outside effects that result in changes in life 
                  expectancy, not explained by the age group. The total of the direct, indirect, and interactive effects will be equivalent 
                  to the total effect, or in this case, the total change in the life expectancy. This is a rudimentary example that can be 
                  extended to other key metrics in the mortality decomposition analysis performed in the Mortality Analysis Calculator. Here 
                  we provide our objectives of assessing each metric:"), 
              HTML("<br><ul><li><b>Life Expectancy</b>: The mortality decomposition of the changes in life expectancy allows us to assess 
                                   each age group, along with the cause of death's attributed contribution to the total change in life expectancy. </li>, 
                        <br><li><b>Life Preparancy</b>: A closer look at the age a population will survive to. This will allow us to have a better
                                   understanding of longevity risk amongst our population of interest.</li>
                        <br><li><b>Gender</b>: We take a deeper dive into life expectancy's gender specific contributions, and the any differences
                                   that can be attributed to gender gap.</li>
                        <br><li><b>Cause of Death</b>: Cause-specific mortality will provide us an additional dimension in mortality decomposition  
                                   analysis. It allows us to track the population's health status, and any mortality trends underlying the changes in 
                                   life expectancy we saw previously.</ul>"), HTML("<br>"),
              a(HTML("<h5 style = 'text-align: left;'><b> Sample Outputs </b></p>"), href = "#graphs"),
              h5("The majority of our exhibits in the Mortality Analysis Calculator will be shown using barplots, heatmaps, and line plots.
                  The visualizations will present our results in an understandable manner. Objectives regarding the analysis for mortality 
                  decomposition by age or by age/cause of death were specified in the previous section. Please note that the sample exhibits
                  presented below are only for demonstration, and the analysis is not just restricted to one metric (e.g. life expectancy). 
                  These exhibits can extend to life expectancy, life preparancy, gender contribution, and cause of death statistics. 
                  Below we present a couple of ways our results were presented:"), 
              HTML("<br><ul><li><b>Barplot for Changes in Life Expectancy</b>: We provide a breakdown of the changes in life expectancy
                                between 2000 and 2010 for males in Taiwan across each age group. Users may hover over the bars to gain a 
                                better estimation of the changes in year for a specific age group. The Mortality Analysis Calculator will 
                                provide additional functionality, where users may press on each bar and see a breakdown of the bar. 
                                This functionality is not shown in our sample output. </li> 
                        <br><li><b>Heatmap for Changes in Life Expectancy</b>: We provide a breakdown of the changes in life expectancy 
                                between 2000 and 2010 for males in Taiwan across all age groups while showing each group's contribution. Users
                                may hover over each shaded box within the heatmap to gain a better estimation of the contribution by age 
                                group to the changes in life expectancy. The heatmap is a consistent exhibit across both mortality decomposition
                                by age or by age/cause of death.</li>
                        <br><li><b>Lineplot for Life Preparancy per Age Group</b>: We provide a lineplot of the life preparancy per age
                                age group at the 90th percentile between 2000 and 2010 for both males and females in Taiwan. Users may 
                                hover over each point within the lineplot to gain a better estimation of the life preparancy estimate. 
                                In addition, users can click on the legend specific label to include or remove specific lines in the plot.</ul>"),
              HTML("<hr></br></br>"), 
                fluidRow(
                  column(width = 6,
                         plotlyOutput("test_barplot", height = 350)), 
                  column(width = 6, 
                         plotlyOutput("test_heatmap", height = 350))
                ), HTML("<hr>"),
                fluidRow(
                  column(width = 12, 
                         plotlyOutput("test_lineplot", height = 350))
                )
              )
            )
          )
        ), 
        
        tabItem( 
            "tab_qa", HTML(paste0("<nobr><b><h3>Frequently Asked Questions</h3></b></nobr>")), hr(),
            fluidRow(
                mainPanel( 
                    title = "Frequently Asked Questions",
                    width = 12,
                    accordion(
                        accordionItem(
                            id = 1,
                            title = HTML("<b>Where can I learn more about mortality decomposition analysis?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("There are plenty of academic research papers that have been published, and continue to be
                            pushed out to help better understand mortality. Simply browsing academic journals would be a
                            great place to start, and get exposed to interesting ways decomposition analysis
                            is being used in mortality studies. In addition, another source would be the
                            <a href='https://www.soa.org/programs/mortality-longevity/' target='_blank'> Society of Actuaries 
                            Mortality & Longevity Strategic Research</a> provides the latest updates on mortality related topics 
                            in research, surveys, and papers."))
                        ),
                        accordionItem(
                            id = 2,
                            title = HTML("<b>What formulas were used in the computation, and how do I recreate the analysis?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("An overview of the decomposition methodologies were introduced in the <em>Documentation</em>
                            section of the MAC. The sources have also been provided and will give a more in-depth and
                            technical look at the computation and derivation of formulas. You can reach out to 
                            <a href='https://www.linkedin.com/in/benjamin-hsu-10b33a97/' target='_blank'> Benjamin Hsu </a>
                            for the code. Contact information can be found in the <em>Community</em> section."))
                        ),
                        accordionItem(
                            id = 3,
                            title = HTML("<b>Where can I get mortality data to analyze?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("All of the data used in the Mortality Analysis Calculator comes from the 
                            <a href='https://www.mortality.org' target='_blank'> Human Mortality Database (HMD) </a>. 
                            You will need to create a username and password in order to access the data."))
                        ),
                        accordionItem(
                            id = 4,
                            title = HTML("<b>What are some advantages of using the MAC?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("The main advantage of using the MAC is that it provides users a way to directly interact 
                            with a flexible interface and receive results with a click of a button. The visualizations
                            are meant to simplify mortality decomposition analysis while retaining key information. By 
                            allowing users to choose their own parameters of interest, we hope to help provide insight
                            through an easy-to-interpret and intuitive platform."))
                        ),
                        accordionItem(
                            id = 5,
                            title = HTML("<b>What countries are available in the analysis?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("The Human Mortality Database (HMD) consists of data for 41 countries. Depending on the 
                            chosen decomposition, a selected portion of the 41 countries may be available."))
                        ),
                        accordionItem(
                            id = 6,
                            title = HTML("<b>Are there courses to learn more about mortality decomposition?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("<a ref = 'https://sps.columbia.edu/academics/masters/actuarial-science', 
                            target = '_blank'> Columbia University's Master of Science in Actuarial Science </a> program provide classes 
                            catered specifically to the actuarial science field. You will get exposed to a wide variety
                            of actuarial topics including mortality decomposition."))
                        ), 
                        accordionItem(
                            id = 7,
                            title = HTML("<b>Who can I contact if I have questions and feedback for the MAC?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("We would love to hear feedback from our users to improve the web application, and 
                            continue to develop more functionality. You can directly email 
                            <a href = 'mailto:bh2722@columbia.edu', target='_blank'> Benjamin Hsu </a> for
                            specific questions and suggestions."))
                        ), 
                        accordionItem(
                            id = 8,
                            title = HTML("<b>What do the version numbers mean?</b>"),
                            color = "info",
                            collapsed = FALSE,
                            HTML(paste0("The version numbers for the MAC allow users to know which version the MAC
                                        is on. The semantic versioning will allow a quick understanding of the type
                                        of updates and changes made to the latest version. Version number will follow 
                                        the following format of: MAJOR.MINOR.PATCH, which corresponds to major changes
                                        in the API, minor functionality and feature additions, and bug fixes."))
                        )
                    )
                )
            )
            )
        )
        
    )    
        
)
    
change5x1 <- function(cntry, t1, t2){
    
    Males_5x1 <- readHMDweb(CNTRY = cntry, item = "mltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    Females_5x1 <- readHMDweb(CNTRY = cntry, item = "fltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    labels <- levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE))
    labels_m <- paste0(levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE)), "M")
    labels_f <- paste0(levels(cut(unique(Females_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Females_5x1$Age), 5)), right = FALSE)), "F")
    
    #create heatmap labels
    age_interest <- gsub(",.*$", "", gsub("\\[|\\)", "", labels)) #gsub the brackets out, and then take lower value before comma
    age_contribution <- paste("Contribution Age", age_interest)
    age_le <- paste("LE Age", age_interest)
    
    #barplot labels
    age_range <- gsub(",", "-", gsub("\\[|\\)", "", labels)) #dash range labels
    
    #start of calculation
    lx_matrix_M<-dcast(Males_5x1,Year~Age,value.var = "lx")
    ex_matrix_M<-dcast(Males_5x1,Year~Age,value.var = "ex")
    lx_matrix_F<-dcast(Females_5x1,Year~Age,value.var = "lx")
    ex_matrix_F<-dcast(Females_5x1,Year~Age,value.var = "ex")
    age_groups<-dim(lx_matrix_M)[2]-1
    
    ## Definition of vectors to be used
    changes_per_age_M<-matrix(0,nrow=age_groups-1,ncol=age_groups-1)
    changes_per_age_F<-matrix(0,nrow=age_groups-1,ncol=age_groups-1)
    changes_per_age_MF <- matrix(0, nrow = age_groups, ncol = age_groups)
    
    for(k in 1:(age_groups-1)){
        d_x_12_M<-matrix(0,nrow=age_groups,ncol=1)
        d_x_21_M<-matrix(0,nrow=age_groups,ncol=1)
        d_x_12_F<-matrix(0,nrow=age_groups,ncol=1)
        d_x_21_F<-matrix(0,nrow=age_groups,ncol=1)
        ##we redefine the vectors lx by dividing them by the respective l0
        ##Case of males
        lx_t1_M<-lx_matrix_M[lx_matrix_M$Year==t1,-1]/lx_matrix_M[lx_matrix_M$Year==t1,k+1]
        lx_t2_M<-lx_matrix_M[lx_matrix_M$Year==t2,-1]/lx_matrix_M[lx_matrix_M$Year==t2,k+1]
        ex_t1_M<-ex_matrix_M[ex_matrix_M$Year==t1,-1]
        ex_t2_M<-ex_matrix_M[ex_matrix_M$Year==t2,-1]
        ##Case of females
        lx_t1_F<-lx_matrix_F[lx_matrix_F$Year==t1,-1]/lx_matrix_F[lx_matrix_F$Year==t1,k+1]
        lx_t2_F<-lx_matrix_F[lx_matrix_F$Year==t2,-1]/lx_matrix_F[lx_matrix_F$Year==t2,k+1]
        ex_t1_F<-ex_matrix_F[ex_matrix_F$Year==t1,-1]
        ex_t2_F<-ex_matrix_F[ex_matrix_F$Year==t2,-1]
        
        
        #<-dim(lx_t1)[2]
        for(x in k:(age_groups-1)){##
            ##Calculation for males
            d_x_12_M[x]<-as.double(lx_t1_M[x])*(as.double(ex_t1_M[x])-as.double(ex_t2_M[x]))-as.double(lx_t1_M[x+1])*(as.double(ex_t1_M[x+1])-as.double(ex_t2_M[x+1]))
            d_x_21_M[x]<-as.double(lx_t2_M[x])*(as.double(ex_t2_M[x])-as.double(ex_t1_M[x]))-as.double(lx_t2_M[x+1])*(as.double(ex_t2_M[x+1])-as.double(ex_t1_M[x+1]))  
            changes_per_age_M[x,k]<-0.5*(d_x_21_M[x]-d_x_12_M[x])
            ##calculation for females
            d_x_12_F[x]<-as.double(lx_t1_F[x])*(as.double(ex_t1_F[x])-as.double(ex_t2_F[x]))-as.double(lx_t1_F[x+1])*(as.double(ex_t1_F[x+1])-as.double(ex_t2_F[x+1]))
            d_x_21_F[x]<-as.double(lx_t2_F[x])*(as.double(ex_t2_F[x])-as.double(ex_t1_F[x]))-as.double(lx_t2_F[x+1])*(as.double(ex_t2_F[x+1])-as.double(ex_t1_F[x+1]))  
            changes_per_age_F[x,k]<-0.5*(d_x_21_F[x]-d_x_12_F[x])
        }
    }

    rownames(changes_per_age_F) <- age_contribution
    colnames(changes_per_age_F) <- age_le
    rownames(changes_per_age_M) <- age_contribution
    colnames(changes_per_age_M) <- age_le
    
    both_genders = cbind(changes_per_age_M, changes_per_age_F)
    total_change_in_age <- apply(both_genders, 2, sum)
    res <- rbind(both_genders, total_change_in_age)
    #add labels
    colnames(res) <- c(labels_m, labels_f)
    row.names(res) <- c(labels, "Total")
    ##The following two quantities are used for a plot
    total_male <- apply(changes_per_age_M, 2, sum)
    total_female <- apply(changes_per_age_F, 2, sum)
    #creating a matrix w/ M/F
    changes_per_age_MF[lower.tri(changes_per_age_MF)] <- changes_per_age_M[lower.tri(changes_per_age_M, diag = TRUE)]
    changes_per_age_MF[upper.tri(changes_per_age_MF)] <- t(changes_per_age_F)[upper.tri(t(changes_per_age_F), diag = TRUE)]
    diag(changes_per_age_MF) <- NA
    rownames(changes_per_age_MF) <- c("", age_contribution)
    colnames(changes_per_age_MF) <- c(age_le, " ")
    
    
    ##Removal of the upper part of matrix since it is always zero
    changes_per_age_M[upper.tri(changes_per_age_M)] <- NA
    changes_per_age_F[upper.tri(changes_per_age_F)] <- NA
    
    
    return(list(changes_per_age_M, changes_per_age_F, changes_per_age_MF))
}

create_hover_MF <- function(x){
    my_rep <- vector() ; my_rep2 <- vector()
    obs_length <- length(x)
    for(k in obs_length:1){
        times <- obs_length - k
        if(k == obs_length){ curr_rep <- c(rep(rev(x)[k], k)) }
        else{ curr_rep <- c(rep(rev(x)[k+1], times), rep(rev(x)[k], k)) }
        my_rep = c(my_rep, curr_rep)
    }
    return(my_rep)
}

change5x1_LP <- function(cntry, t1, t2, z){
    #CLP calculation
    
    Males_5x1 <- readHMDweb(CNTRY = cntry, item = "mltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    Females_5x1 <- readHMDweb(CNTRY = cntry, item = "fltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    labels <- levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE))
    labels_m <- paste0(levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE)), "M")
    labels_f <- paste0(levels(cut(unique(Females_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Females_5x1$Age), 5)), right = FALSE)), "F")
    
    #age group equivalence
    age_interest <- gsub(",.*$", "", gsub("\\[|\\)", "", labels)) #gsub the brackets out, and then take lower value before comma
    age_contribution <- paste("Contribution Age", age_interest)
    age_lp <- paste("LP Age", age_interest)
    age_range <- gsub(",", "-", gsub("\\[|\\)", "", labels)) #dash range labels
    age_group <- 1:length(age_interest)
    age_group_equiv <- data.frame(Age_Label = age_range, Age_Group = age_group, Initial_Age = age_interest)
    
    lx_matrix_M<-dcast(Males_5x1,Year~Age,value.var = "lx")
    lx_matrix_F<-dcast(Females_5x1,Year~Age,value.var = "lx")
    
    initial_ages <- as.matrix(as.numeric(as.character(age_group_equiv$Initial_Age)))
    ages<-(dim(lx_matrix_M[,-1])[2])-1##ages is the number of ages present in the life table, per year
    life_preparancy_female_t1<-matrix(0,nrow=ages,ncol=1)
    life_preparancy_female_t2<-matrix(0,nrow=ages,ncol=1)
    life_preparancy_male_t1<-matrix(0,nrow=ages,ncol=1)
    life_preparancy_male_t2<-matrix(0,nrow=ages,ncol=1)
    survivors_male_t1<-matrix(0,nrow=1,ncol=ages)
    survivors_male_t2<-matrix(0,nrow=1,ncol=ages)
    survivors_female_t1<-matrix(0,nrow=1,ncol=ages)
    survivors_female_t2<-matrix(0,nrow=1,ncol=ages)
    d_x_12_M<-matrix(0,nrow=ages,ncol=1)
    d_x_21_M<-matrix(0,nrow=ages,ncol=1)
    d_x_12_F<-matrix(0,nrow=ages,ncol=1)
    d_x_21_F<-matrix(0,nrow=ages,ncol=1)
    changes_per_age_M<-matrix(0,nrow=ages,ncol=1)
    changes_per_age_F<-matrix(0,nrow=ages,ncol=1)
    
    ##we redine the vectors lx for the years of interest by dividing them by the respective l0
    ##Case of males
    lx_t1_M<-lx_matrix_M[lx_matrix_M$Year==t1,-1]/lx_matrix_M[lx_matrix_M$Year==t1,2]
    lx_t2_M<-lx_matrix_M[lx_matrix_M$Year==t2,-1]/lx_matrix_M[lx_matrix_M$Year==t2,2]
    ##no need for group 110+ since causes of death ends with 105+
    lx_t1_M<-as.matrix(lx_t1_M[,-ncol(lx_t1_M)])
    lx_t2_M<-as.matrix(lx_t2_M[,-ncol(lx_t2_M)])
    ##Case of females
    lx_t1_F<-lx_matrix_F[lx_matrix_F$Year==t1,-1]/lx_matrix_F[lx_matrix_F$Year==t1,2]
    lx_t2_F<-lx_matrix_F[lx_matrix_F$Year==t2,-1]/lx_matrix_F[lx_matrix_F$Year==t2,2]
    ##no need for group 110+ since causes of death ends with 105+
    lx_t1_F<-as.matrix(lx_t1_F[,-ncol(lx_t1_F)])
    lx_t2_F<-as.matrix(lx_t2_F[,-ncol(lx_t2_F)])
    
    ##We'll compute the amount of survivors considered necessary to define the life preparancy per age
    survivors_male_t1[1,]<-as.matrix((1-z/100)*lx_t1_M)##survivors used as reference for life preparancy males
    survivors_male_t2[1,]<-as.matrix((1-z/100)*lx_t2_M)
    survivors_female_t1[1,]<-as.matrix((1-z/100)*lx_t1_F)##survivors used as reference for life preparanacy female
    survivors_female_t2[1,]<-as.matrix((1-z/100)*lx_t2_F)
    ##We now compute the life preparancy per age for every age and the years of interest
    for(x in 1:(ages)){
        #This counts the last position of the survivor vector that exceeds the required number of 
        #survivors based on the percentile
        cm_t1<-lx_t1_M<survivors_male_t1[x]
        cm_t2<-lx_t2_M<survivors_male_t2[x]
        cf_t1<-lx_t1_F<survivors_female_t1[x]
        cf_t2<-lx_t2_F<survivors_female_t2[x]
        ###Interpolation to obtain the life preparancy year t1 males
        t1_d1_M <- lx_t1_M[length(which(cm_t1 == FALSE))] - survivors_male_t1[x]
        t1_d2_M <- survivors_male_t1[x] - lx_t1_M[min(length(which(cm_t1 == FALSE))+1, ages)]
        t1_d_M <- t1_d1_M + t1_d2_M
        life_preparancy_male_t1[x] <- as.double((t1_d2_M/t1_d_M)*initial_ages[length(which(cm_t1 == FALSE))] + (t1_d1_M/t1_d_M)*initial_ages[min(length(which(cm_t1 == FALSE))+1, ages)])
        ###Interpolation to obtain the life preparancy t1 females
        t1_d1_F<-lx_t1_F[(length(which(cf_t1=="FALSE")))]-survivors_female_t1[x]
        t1_d2_F<-survivors_female_t1[x]-lx_t1_F[min((length(which(cf_t1=="FALSE")))+1,ages)]
        t1_d_F<-t1_d1_F+t1_d2_F
        life_preparancy_female_t1[x]<-as.double(( t1_d2_F/t1_d_F)*initial_ages[((length(which(cf_t1=="FALSE"))))]+(t1_d1_F/t1_d_F)*initial_ages[min(((length(which(cf_t1=="FALSE"))))+1,ages)])
        ###Interpolation to obtain the life preparancy year t2 males
        t2_d1_M<-lx_t2_M[(length(which(cm_t2=="FALSE")))]-survivors_male_t2[x]
        t2_d2_M<-survivors_male_t2[x]-lx_t2_M[min((length(which(cm_t2=="FALSE")))+1,ages)]
        t2_d_M<-t2_d1_M+t2_d2_M
        life_preparancy_male_t2[x]<-as.double((t2_d2_M/t2_d_M)*initial_ages[(length(which(cm_t2=="FALSE")))]+(t2_d1_M/t2_d_M)*initial_ages[min(((length(which(cm_t2=="FALSE"))))+1,ages)])
        ###Interpolation to obtain the life preparancy year t2 females
        t2_d1_F<-lx_t2_F[(length(which(cf_t2=="FALSE")))]-survivors_female_t2[x]
        t2_d2_F<-survivors_female_t2[x]-lx_t2_F[min((length(which(cf_t2=="FALSE")))+1,ages)]
        t2_d_F<-t2_d1_F+t2_d2_F
        life_preparancy_female_t2[x]<-as.double((t2_d2_F/t2_d_F)*initial_ages[((length(which(cf_t2=="FALSE"))))]+(t2_d1_F/t2_d_F)*initial_ages[min(((length(which(cf_t2=="FALSE"))))+1,ages)])
    }
    ##When estimating life preparancy requires the number of survivors at x=111, formula returns na
    ##We assign the maximum age in this case, since no one is assumed to survive beyond age 110
    life_preparancy_male_t1[is.na(life_preparancy_male_t1)]<-initial_ages[nrow(initial_ages)]
    life_preparancy_male_t2[is.na(life_preparancy_male_t2)]<-initial_ages[nrow(initial_ages)]
    life_preparancy_female_t1[is.na(life_preparancy_female_t1)]<-initial_ages[nrow(initial_ages)]
    life_preparancy_female_t2[is.na(life_preparancy_female_t2)]<-initial_ages[nrow(initial_ages)]
    
    result <- data.frame(initial = initial_ages, 
                         malet1 = life_preparancy_male_t1, femalet1 = life_preparancy_female_t1, 
                         malet2 = life_preparancy_male_t2, femalet2 = life_preparancy_female_t2)
    row.names(result) <- age_range
    
    #start of change in life preparancy
    
    age_groups <- length(age_group)
    ## Definition of vectors to be used
    changes_per_age_M<-matrix(0,nrow=age_groups-1,ncol=age_groups-1)
    changes_per_age_F<-matrix(0,nrow=age_groups-1,ncol=age_groups-1)
    changes_per_age_MF <- matrix(0, nrow = age_groups, ncol = age_groups)
    
    for(k in 1:(age_groups-1)){
        d_x_12_M<-matrix(0,nrow=age_groups,ncol=1)
        d_x_21_M<-matrix(0,nrow=age_groups,ncol=1)
        d_x_12_F<-matrix(0,nrow=age_groups,ncol=1)
        d_x_21_F<-matrix(0,nrow=age_groups,ncol=1)
        ##we redefine the vectors lx by dividing them by the respective l0
        ##Case of males
        lx_t1_M<-lx_matrix_M[lx_matrix_M$Year==t1,-1]/lx_matrix_M[lx_matrix_M$Year==t1,k+1]
        lx_t2_M<-lx_matrix_M[lx_matrix_M$Year==t2,-1]/lx_matrix_M[lx_matrix_M$Year==t2,k+1]
        ##Case of females
        lx_t1_F<-lx_matrix_F[lx_matrix_F$Year==t1,-1]/lx_matrix_F[lx_matrix_F$Year==t1,k+1]
        lx_t2_F<-lx_matrix_F[lx_matrix_F$Year==t2,-1]/lx_matrix_F[lx_matrix_F$Year==t2,k+1]
        
        for(x in k:(age_groups-1)){##
            ##Calculation for males
            d_x_12_M[x]<-as.double(lx_t1_M[x])*(as.double(result[x,2])-as.double(result[x,4]))-as.double(lx_t1_M[x+1])*(as.double(result[x+1,2])-as.double(result[x+1,4]))
            d_x_21_M[x]<-as.double(lx_t2_M[x])*(as.double(result[x,4])-as.double(result[x,2]))-as.double(lx_t2_M[x+1])*(as.double(result[x+1,4])-as.double(result[x+1,2]))  
            changes_per_age_M[x,k]<-0.5*(d_x_21_M[x]-d_x_12_M[x])
            ##calculation for females
            d_x_12_F[x]<-as.double(lx_t1_F[x])*(as.double(result[x,3])-as.double(result[x,5]))-as.double(lx_t1_F[x+1])*(as.double(result[x+1,3])-as.double(result[x+1,5]))
            d_x_21_F[x]<-as.double(lx_t2_F[x])*(as.double(result[x,5])-as.double(result[x,3]))-as.double(lx_t2_F[x+1])*(as.double(result[x+1,5])-as.double(result[x+1,3]))  
            changes_per_age_F[x,k]<-0.5*(d_x_21_F[x]-d_x_12_F[x])
        }
    }
    
    rownames(changes_per_age_F)<-age_contribution[-length(age_contribution)]
    colnames(changes_per_age_F)<-age_lp[-length(age_lp)]
    rownames(changes_per_age_M)<-age_contribution[-length(age_contribution)]
    colnames(changes_per_age_M)<-age_lp[-length(age_lp)]
    
    both_genders<-cbind(changes_per_age_M,changes_per_age_F)
    total_change_in_Age <- apply(both_genders,2,sum)
    res <- rbind(both_genders,total_change_in_Age)
    colnames(res) <- c(labels_m[-length(labels_m)], labels_f[-length(labels_f)])
    row.names(res) <- c(labels[-length(labels)], "Total")
    
    #creating a matrix w/ M/F
    changes_per_age_MF[lower.tri(changes_per_age_MF)] <- changes_per_age_M[lower.tri(changes_per_age_M, diag = TRUE)]
    changes_per_age_MF[upper.tri(changes_per_age_MF)] <- t(changes_per_age_F)[upper.tri(t(changes_per_age_F), diag = TRUE)]
    diag(changes_per_age_MF) <- NA
    rownames(changes_per_age_MF) <- c("", age_contribution[-length(age_contribution)])
    colnames(changes_per_age_MF) <- c(age_lp[-length(age_lp)], " ")
    
    ##Removal of the upper part of matrix since it is always zero
    changes_per_age_M[upper.tri(changes_per_age_M)] <- NA
    changes_per_age_F[upper.tri(changes_per_age_F)] <- NA
    
    return(list(result, changes_per_age_M, changes_per_age_F, changes_per_age_MF))
}


GenGap_Age <-function(cntry, t){
    ##########
    
    Males_5x1 <- readHMDweb(CNTRY = cntry, item = "mltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    Females_5x1 <- readHMDweb(CNTRY = cntry, item = "fltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    labels <- levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE))
    labels_m <- paste0(levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE)), "M")
    labels_f <- paste0(levels(cut(unique(Females_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Females_5x1$Age), 5)), right = FALSE)), "F")
    
    #create heatmap labels
    age_interest <- gsub(",.*$", "", gsub("\\[|\\)", "", labels)) #gsub the brackets out, and then take lower value before comma
    age_range <- gsub(",", "-", gsub("\\[|\\)", "", labels)) #dash range labels
    
    ##In here, F stands for Females, M for males
    lx_matrix_M<<-dcast(Males_5x1,Year~Age,value.var = "lx")
    ex_matrix_M<<-dcast(Males_5x1,Year~Age,value.var = "ex")
    lx_matrix_F<<-dcast(Females_5x1,Year~Age,value.var = "lx")
    ex_matrix_F<<-dcast(Females_5x1,Year~Age,value.var = "ex")
    age_groups<-dim(lx_matrix_M[,-1])[2]-1
    ## Definition of vectors to be used
    Total_Change_per_age<-matrix(0,nrow=age_groups,ncol=age_groups)
    #Extraction of information associated to variables of interest for year t
    #First column contains the year, thus it is removed
    lx_M_general<-lx_matrix_M[lx_matrix_M$Year==t,-1]
    ex_M_general<-ex_matrix_M[ex_matrix_M$Year==t,-1]
    lx_F_general<-lx_matrix_F[lx_matrix_F$Year==t,-1]
    ex_F_general<-ex_matrix_F[ex_matrix_F$Year==t,-1]
    ######
    for(k in 0:(age_groups-1)){
        d_x_12<-matrix(0,nrow=age_groups,ncol=1)
        d_x_21<-matrix(0,nrow=age_groups,ncol=1)
        ##we redefine the vectors lx by dividing them by the respective l0
        ##Case of males
        lx_M<-lx_M_general/lx_matrix_M[lx_matrix_M$Year==t,k+1]
        ex_M<-ex_M_general
        ##Case of females
        lx_F<-lx_F_general/lx_matrix_F[lx_matrix_F$Year==t,k+1]
        ex_F<-ex_F_general
        
        for(x in k:(age_groups-1)){##
            ##Calculation algorithm From Andreev
            d_x_12[x]<-as.double(lx_M[x])*(as.double(ex_M[x])-as.double(ex_F[x]))-as.double(lx_M[x+1])*(as.double(ex_M[x+1])-as.double(ex_F[x+1]))
            d_x_21[x]<-as.double(lx_F[x])*(as.double(ex_F[x])-as.double(ex_M[x]))-as.double(lx_F[x+1])*(as.double(ex_F[x+1])-as.double(ex_M[x+1]))
            Total_Change_per_age[x,k]<-0.5*(d_x_21[x]-d_x_12[x])
        }
    }      
    #######
    
    Total_Gap<-apply(Total_Change_per_age,2,sum)
    result_WT<-rbind(Total_Change_per_age,Total_Gap)
    rownames(result_WT)<-c(age_interest, "Total")
    colnames(result_WT)<-age_interest
    
    Total_Change_per_age_df <- data.frame(age_interest, t(Total_Change_per_age))
    colnames(Total_Change_per_age_df) <- c("age_interest", age_interest)
    Total_Change_per_age_melt <- melt(Total_Change_per_age_df, id.vars = c("age_interest"))
    
    
    # create table for this
    Total_Change_per_age_df2 <- data.frame(Total_Change_per_age)
    colnames(Total_Change_per_age_df2) <- paste("Age", age_interest)
    rownames(Total_Change_per_age_df2) <- age_range
    Total_Change_per_age_df2 <- Total_Change_per_age_df2 %>% rownames_to_column() %>% rename(Contribution = rowname)
    Total_Change_per_age_melt2 <- melt(Total_Change_per_age_df2, id.vars = c("Contribution"))
    table_change <- Total_Change_per_age_melt2[!(Total_Change_per_age_melt2$value == 0),] %>% 
                        mutate_if(is.numeric, round, 5) %>% rename("Age Group" = variable, Value = value) %>% 
                        select("Age Group", Contribution, Value) %>% mutate_at(vars(Contribution), factor)
    
    #final output
    return(list(table_change, Total_Change_per_age_melt, result_WT))
}

change5x1_AgeCOD <- function(cntry, t1, t2){
    
    Males_5x1 <- readHMDweb(CNTRY = cntry, item = "mltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    Females_5x1 <- readHMDweb(CNTRY = cntry, item = "fltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
    labels <- levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE))
    labels_m <- paste0(levels(cut(unique(Males_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Males_5x1$Age), 5)), right = FALSE)), "M")
    labels_f <- paste0(levels(cut(unique(Females_5x1$Age), breaks = c(0, 1, 5, seq(10, max(Females_5x1$Age), 5)), right = FALSE)), "F")
    
    #create heatmap labels
    age_interest <- gsub(",.*$", "", gsub("\\[|\\)", "", labels)) #gsub the brackets out, and then take lower value before comma
    age_range <- gsub(",", "-", gsub("\\[|\\)", "", labels)) #dash range labels
    age_equivalence <- data.frame(initial = age_interest, range = age_range)
    
    ###We reshape the lx, ex information downloaded in a more convinient way
    lx_matrix_M<-dcast(Males_5x1,Year~Age,value.var = "lx")
    ex_matrix_M<-dcast(Males_5x1,Year~Age,value.var = "ex")
    lx_matrix_F<-dcast(Females_5x1,Year~Age,value.var = "lx")
    ex_matrix_F<-dcast(Females_5x1,Year~Age,value.var = "ex")
    
    ####We reshape the rates per disease info in a more convenient way
    COD_Info <- read.csv(paste0("COD_5x1_chapters_", cntry, ".csv"))
    rates_per_chapter_males<-dcast(COD_Info,Year+COD.chap~Age,value.var = "Rates.M")
    rates_per_chapter_females<-dcast(COD_Info,Year+COD.chap~Age,value.var = "Rates.F")
    
    ##We'll obtain the amounts corresponding to exposed to risk for males and females (all ages)
    ##in the years of interest
    rates_per_chapter_males_t1<-as.matrix(rates_per_chapter_males[rates_per_chapter_males$Year==t1,-(1:2)])/1000
    rates_per_chapter_males_t2<-as.matrix(rates_per_chapter_males[rates_per_chapter_males$Year==t2,-(1:2)])/1000
    rates_per_chapter_females_t1<-as.matrix(rates_per_chapter_females[rates_per_chapter_females$Year==t1,-(1:2)])/1000
    rates_per_chapter_females_t2<-as.matrix(rates_per_chapter_females[rates_per_chapter_females$Year==t2,-(1:2)])/1000
    
    mortality_chapters<-nrow(rates_per_chapter_males_t1)-1
    age_groups<- length(age_interest) #dim(rates_per_chapter_males[,-(1:2)])[2]
    
    #20 mortality chapters, and 23 age groups -- 21 is the total 
    
    for(k in 1:(mortality_chapters+1)){
        ##Detection of last column with non NA values. "lcgi" stands for last column gender year i 
        lcm1 <- dim(rates_per_chapter_males_t1)[2]-length(rates_per_chapter_males_t1[k,which(is.na(rates_per_chapter_males_t1[k,]))])
        lcm2<-dim(rates_per_chapter_males_t2)[2]-length(rates_per_chapter_males_t2[k,which(is.na(rates_per_chapter_males_t2[k,]))])
        lcf1<-dim(rates_per_chapter_females_t1)[2]-length(rates_per_chapter_females_t1[k,which(is.na(rates_per_chapter_females_t1[k,]))])
        lcf2<-dim(rates_per_chapter_females_t2)[2]-length(rates_per_chapter_females_t2[k,which(is.na(rates_per_chapter_females_t2[k,]))])
        ###replacement of na 
        rates_per_chapter_males_t1[k,is.na(rates_per_chapter_males_t1[k,])]<-rates_per_chapter_males_t1[k,lcm1]
        rates_per_chapter_males_t2[k,is.na(rates_per_chapter_males_t2[k,])]<-rates_per_chapter_males_t2[k,lcm2]
        rates_per_chapter_females_t1[k,is.na(rates_per_chapter_females_t1[k,])]<-rates_per_chapter_females_t1[k,lcf1]
        rates_per_chapter_females_t2[k,is.na(rates_per_chapter_females_t2[k,])]<-rates_per_chapter_females_t2[k,lcf2]
    }
    
    ##Every column of matrix will represent an age group and every row a chapter of cause of death
    Proportion_Change_rate_of_mortality_t1_t2_male<-matrix(0,nrow=20,ncol=age_groups)
    Proportion_Change_rate_of_mortality_t1_t2_female<-matrix(0,nrow=20,ncol=age_groups)
    Contribution_chapter_male<-matrix(0,nrow=20,ncol=age_groups)
    Contribution_chapter_female<-matrix(0,nrow=20,ncol=age_groups)
    Change_rate_of_mortality_t1_t2_male<-as.matrix(rates_per_chapter_males_t1[21,])-as.matrix(rates_per_chapter_males_t2[21,])
    Change_rate_of_mortality_t1_t2_female<-as.matrix(rates_per_chapter_females_t1[21,])-as.matrix(rates_per_chapter_females_t2[21,])
    
    ##we compute the respective PROPORTIONAL changes in mortality
    for(i in 1:mortality_chapters){
        Proportion_Change_rate_of_mortality_t1_t2_male[i,]<-(rates_per_chapter_males_t1[i,]-rates_per_chapter_males_t2[i,])/t(Change_rate_of_mortality_t1_t2_male)
        Proportion_Change_rate_of_mortality_t1_t2_female[i,]<-(rates_per_chapter_females_t1[i,]-rates_per_chapter_females_t2[i,])/t(Change_rate_of_mortality_t1_t2_female)
    }
    ###some NA may be generated in the results when dividing by a rate that is 0. We remove them 
    Proportion_Change_rate_of_mortality_t1_t2_male[is.na(Proportion_Change_rate_of_mortality_t1_t2_male)]<-0
    Proportion_Change_rate_of_mortality_t1_t2_female[is.na(Proportion_Change_rate_of_mortality_t1_t2_female)]<-0
    
    #output
    return(list(Proportion_Change_rate_of_mortality_t1_t2_male, Proportion_Change_rate_of_mortality_t1_t2_female))
}

mortality_chapter_rates <- function(cntry, t1, t2){
    #import the file
    COD_Info <- read.csv(paste0("COD_5x1_chapters_", cntry, ".csv"))
    rates_per_chapter_males <- dcast(COD_Info,Year+COD.chap~Age,value.var = paste0("Rates.M"))
    rates_per_chapter_females <- dcast(COD_Info,Year+COD.chap~Age,value.var = paste0("Rates.F"))
    
    #parameters
    mortality_chapters <- max(rates_per_chapter_males$COD.chap)-1 #20 mortality chapters, 21st is total
    age_groups <- length(unique(COD_Info$Age)) #number of age groups
    
    #animation rates
    t1 = as.numeric(t1) ; t2 = as.numeric(t2)
    rates_animate_M <- as.matrix(rates_per_chapter_males[rates_per_chapter_males$Year == t1 | rates_per_chapter_males$Year == t2, -(1:2)])/1000
    rates_animate_F <- as.matrix(rates_per_chapter_females[rates_per_chapter_females$Year == t1 | rates_per_chapter_females$Year == t2, -(1:2)])/1000
    rates_animate_labels <- data.frame(chapter = rep(1:(mortality_chapters+1), 2), 
                                       year = rep(c(t1, t2), each = mortality_chapters+1)) 
    #final rates
    rates_animate_Mf <- cbind(rates_animate_labels, data.frame(Gender = "Male"), rates_animate_M) 
    rates_animate_Ff <- cbind(rates_animate_labels, data.frame(Gender = "Female"), rates_animate_F)
    rates_animate_final <- rbind(rates_animate_Mf, rates_animate_Ff)
    
    return(rates_animate_final)
}

GenGap_AgeCOD <- function(cntry, t){
    #import the file
    COD_Info <- read.csv(paste0("COD_5x1_chapters_", cntry, ".csv"))
    
    #fractional mortality rates
    Cause_Mortality_Fractions_M<-dcast(COD_Info,Year+COD.chap~Age,value.var = "COD.frac.M")
    Cause_Mortality_Fractions_F<-dcast(COD_Info,Year+COD.chap~Age,value.var = "COD.frac.F")
    rates_per_chapter_males<-dcast(COD_Info,Year+COD.chap~Age,value.var = "Rates.M")
    rates_per_chapter_females<-dcast(COD_Info,Year+COD.chap~Age,value.var = "Rates.F")
    
    ##Extraction of information for year t
    Cause_Mortality_Fractions_F_t<-as.matrix(Cause_Mortality_Fractions_F[Cause_Mortality_Fractions_F$Year==t,-(1:2)])#Just the specific year required and no need for descriptive columns
    Cause_Mortality_Fractions_M_t<-as.matrix(Cause_Mortality_Fractions_M[Cause_Mortality_Fractions_M$Year==t,-(1:2)])
    
    #parameters
    mortality_chapters <- max(rates_per_chapter_males$COD.chap)-1 #20 mortality chapters, 21st is total
    age_groups <- length(unique(COD_Info$Age)) #number of age groups
    
    ###This section completes the matrix for cases of countries with years missing information about certain advanced
    ###ages. For example, the case of CZE for ages 85-90,90-95,95-100,100-105 before year 1986. In such a case,
    #These ages are filled with the value in age 85 (which corresponds to 85+)
    for(k in 1:(mortality_chapters+1)){
        ##Detection of last column with non NA values. "lcgt" stands for last column with info gender year i 
        lcft<-dim(Cause_Mortality_Fractions_F_t)[2]-length(Cause_Mortality_Fractions_F_t[k,which(is.na(Cause_Mortality_Fractions_F_t[k,]))])
        lcmt<-dim(Cause_Mortality_Fractions_M_t)[2]-length(Cause_Mortality_Fractions_M_t[k,which(is.na(Cause_Mortality_Fractions_M_t[k,]))])
        ###replacement of na 
        Cause_Mortality_Fractions_F_t[k,is.na(Cause_Mortality_Fractions_F_t[k,])]<-Cause_Mortality_Fractions_F_t[k,lcft]
        Cause_Mortality_Fractions_M_t[k,is.na(Cause_Mortality_Fractions_M_t[k,])]<-Cause_Mortality_Fractions_M_t[k,lcmt]
    }
    #extract only rates per chapter for year t
    rates_per_chapter_males_t<-as.matrix(rates_per_chapter_males[rates_per_chapter_males$Year==t,-(1:2)])
    rates_per_chapter_females_t<-as.matrix(rates_per_chapter_females[rates_per_chapter_females$Year==t,-(1:2)])
    
    ###This section completes the matrix for cases of countries with years missing information about certain advanced
    ###ages. For example, the case of CZE for ages 85-90,90-95,95-100,100-105 before year 1986. In such a case,
    #These ages are filled with the value in age 85 (which corresponds to 85+)
    for(k in 1:(mortality_chapters+1)){
        ##Detection of last column with non NA values. "lcgi" stands for last column gender year i 
        lcmt<-dim(rates_per_chapter_males_t)[2]-length(rates_per_chapter_males_t[k,which(is.na(rates_per_chapter_males_t[k,]))])
        lcft<-dim(rates_per_chapter_females_t)[2]-length(rates_per_chapter_females_t[k,which(is.na(rates_per_chapter_females_t[k,]))])
        ###replacement of na 
        rates_per_chapter_males_t[k,is.na(rates_per_chapter_males_t[k,])]<-rates_per_chapter_males_t[k,lcmt]
        rates_per_chapter_females_t[k,is.na(rates_per_chapter_females_t[k,])]<-rates_per_chapter_females_t[k,lcft]
    }
    
    return(list(Cause_Mortality_Fractions_M_t, Cause_Mortality_Fractions_F_t, rates_per_chapter_males_t, rates_per_chapter_females_t))
}


server <- shinyServer(function(input, output, session){ 
        
        #manual changing
        observeEvent(input$tabs_all, {
          # Drop the leading '#' symbol
          hash <- substring(getUrlHash(), 2)
          
          # This is so we don't 'update' to the tab we're already in (since clicking on 
          # the sidebar already switches tabs.)
          if (hash != input$tabs_all) {
            # The 'push' argument is necessary so that the hash change event occurs and
            # so that the other observer is triggered.
            updateQueryString(paste0("#", input$tabs_all), mode = "push")
          }
        }, ignoreInit = TRUE)
        
        observeEvent(getUrlHash(), {
          hash <- substring(getUrlHash(), 2)
          updateTabItems(session, "tabs_all", hash)
        })

        #homepage reactie action buttons
        observeEvent(input$explore_more, {
            newtab <- switch(input$tabs_all, "tab_home" = "tab_explore")
            updateTabItems(session, "tabs_all", newtab)
        })
        observeEvent(input$instruc_more, {
            newtab <- switch(input$tabs_all, "tab_home" = "tab_instructions")
            updateTabItems(session, "tabs_all", newtab)
        })
        observeEvent(input$qa_more, {
            newtab <- switch(input$tabs_all, "tab_home" = "tab_qa")
            updateTabItems(session, "tabs_all", newtab)
        })
        
        #explore reactie action buttons
        observeEvent(input$start_more, {
            newtab <- switch(input$tabs_all, "tab_explore" = "tab_le")
            updateTabItems(session, "tabs_all", newtab)
        })
        observeEvent(input$news_more, {
            newtab <- switch(input$tabs_all, "tab_explore" = "tab_news")
            updateTabItems(session, "tabs_all", newtab)
        })
        observeEvent(input$faq_more, {
            newtab <- switch(input$tabs_all, "tab_explore" = "tab_qa")
            updateTabItems(session, "tabs_all", newtab)
        })
        
        #slickR
        output$slickr <- renderSlickR({
            imgs <- c("soa_banner.jpg", "sps_banner.jpg")
            slickR(imgs)
        })
        
        #options(warn = -1) 
        
        #Age conditional panel for country time range
        output$addControls <- renderUI({
            if(is.null(input$heatCountry)) return()
            switch(input$heatCountry, 
                   "Australia" = sliderInput("range_t", label = "Years Selected",
                                             min = 1921, max = 2018, value = c(1921, 2018), sep = ""),
                   "Austria" = sliderInput("range_t", label = "Years Selected",
                                           min = 1947, max = 2017, value = c(1947, 2017), sep = ""),
                   "Belarus" = sliderInput("range_t", label = "Years Selected",
                                           min = 1959, max = 2018, value = c(1959, 2018), sep = ""),
                   "Belgium" = sliderInput("range_t", label = "Years Selected",
                                           min = 1841, max = 2018, value = c(1841, 2018), sep = ""),
                   "Bulgaria" = sliderInput("range_t", label = "Years Selected",
                                            min = 1947, max = 2018, value = c(1947, 2017), sep = ""),
                   "Canada" = sliderInput("range_t", label = "Years Selected",
                                          min = 1921, max = 2016, value = c(1921, 2016), sep = ""),
                   "Chile" = sliderInput("range_t", label = "Years Selected",
                                         min = 1992, max = 2008, value = c(1992, 2008), sep = ""),
                   "Czech Republic" = sliderInput("range_t", label = "Years Selected",
                                                  min = 1950, max = 2018, value = c(1950, 2018), sep = ""),
                   "Denmark" = sliderInput("range_t", label = "Years Selected",
                                           min = 1835, max = 2019, value = c(1835, 2019), sep = ""),
                   "Estonia" = sliderInput("range_t", label = "Years Selected",
                                           min = 1959, max = 2017, value = c(1959, 2017), sep = ""),
                   "Finland" = sliderInput("range_t", label = "Years Selected",
                                           min = 1878, max = 2018, value = c(1878, 2018), sep = ""),
                   "France" = sliderInput("range_t", label = "Years Selected",
                                          min = 1816, max = 2017, value = c(1816, 2018), sep = ""),
                   "Germany" = sliderInput("range_t", label = "Years Selected",
                                           min = 1990, max = 2017, value = c(1990, 2017), sep = ""),
                   "Greece" = sliderInput("range_t", label = "Years Selected",
                                          min = 1981, max = 2017, value = c(1981, 2017), sep = ""),
                   "Hungary" = sliderInput("range_t", label = "Years Selected",
                                           min = 1950, max = 2017, value = c(1950, 2017), sep = ""),
                   "Iceland" = sliderInput("range_t", label = "Years Selected",
                                           min = 1838, max = 2018, value = c(1838, 2018), sep = ""),
                   "Ireland" = sliderInput("range_t", label = "Years Selected",
                                           min = 1950, max = 2018, value = c(1950, 2017), sep = ""),
                   "Israel" = sliderInput("range_t", label = "Years Selected",
                                          min = 1983, max = 2016, value = c(1983, 2016), sep = ""),
                   "Italy" = sliderInput("range_t", label = "Years Selected",
                                         min = 1872, max = 2017, value = c(1872, 2017), sep = ""),
                   "Japan" = sliderInput("range_t", label = "Years Selected",
                                         min = 1947, max = 2018, value = c(1947, 2018), sep = ""),
                   "Korea" = sliderInput("range_t", label = "Years Selected",
                                         min = 2003, max = 2018, value = c(2003, 2018), sep = ""),
                   "Latvia" = sliderInput("range_t", label = "Years Selected",
                                          min = 1959, max = 2017, value = c(1959, 2017), sep = ""),
                   "Lithuania" = sliderInput("range_t", label = "Years Selected",
                                             min = 1959, max = 2017, value = c(1959, 2017), sep = ""),
                   "Luxembourg" = sliderInput("range_t", label = "Years Selected",
                                              min = 1960, max = 2017, value = c(1960, 2017), sep = ""),
                   "Netherlands" = sliderInput("range_t", label = "Years Selected",
                                               min = 1850, max = 2018, value = c(1850, 2018), sep = ""),
                   "New Zealand" = sliderInput("range_t", label = "Years Selected",
                                               min = 1948, max = 2013, value = c(1948, 2013), sep = ""),
                   "Norway" = sliderInput("range_t", label = "Years Selected",
                                          min = 1846, max = 2018, value = c(1846, 2018), sep = ""),
                   "Poland" = sliderInput("range_t", label = "Years Selected",
                                          min = 1958, max = 2018, value = c(1958, 2018), sep = ""),
                   "Portugal" = sliderInput("range_t", label = "Years Selected",
                                            min = 1940, max = 2018, value = c(1940, 2018), sep = ""),
                   "Russia" = sliderInput("range_t", label = "Years Selected",
                                          min = 1959, max = 2014, value = c(1959, 2014), sep = ""),
                   "Slovakia" = sliderInput("range_t", label = "Years Selected",
                                            min = 1950, max = 2017, value = c(1950, 2017), sep = ""),
                   "Slovenia" = sliderInput("range_t", label = "Years Selected",
                                            min = 1983, max = 2017, value = c(1983, 2017), sep = ""),
                   "Spain" = sliderInput("range_t", label = "Years Selected",
                                         min = 1908, max = 2018, value = c(1908, 2018), sep = ""),
                   "Sweden" = sliderInput("range_t", label = "Years Selected",
                                          min = 1751, max = 2018, value = c(1751, 2018), sep = ""),
                   "Switzerland" = sliderInput("range_t", label = "Years Selected",
                                               min = 1876, max = 2018, value = c(1876, 2018), sep = ""),
                   "Taiwan" = sliderInput("range_t", label = "Years Selected",
                                          min = 1970, max = 2014, value = c(1970, 2014), sep = ""),
                   "Great Britain" = sliderInput("range_t", label = "Years Selected",
                                                 min = 1841, max = 2016, value = c(1841, 2016), sep = ""),
                   "Scotland" = sliderInput("range_t", label = "Years Selected",
                                            min = 1855, max = 2016, value = c(1855, 2016), sep = ""),
                   "Northern Ireland" = sliderInput("range_t", label = "Years Selected",
                                                    min = 1922, max = 2016, value = c(1922, 2016), sep = ""),
                   "USA" = sliderInput("range_t", label = "Years Selected",
                                         min = 1933, max = 2017, value = c(1933, 2017), sep = ""),
                   "Ukraine" = sliderInput("range_t", label = "Years Selected",
                                           min = 1959, max = 2013, value = c(1959, 2013), sep = "")
            )
        })
        
        #COD conditional panel for country time range
        output$moreControls <- renderUI({
            if(is.null(input$CODCountry)) return()
            switch(input$CODCountry, 
                   "Canada" = sliderInput("range_tcod",
                                          label = "Years Selected",
                                          min = 1950, max = 2009, value = c(1950, 2009), sep = ""),
                   "Czech Republic" = sliderInput("range_tcod",
                                                  label = "Years Selected",
                                                  min = 1950, max = 2013, value = c(1950, 2013), sep = ""),
                   "France" = sliderInput("range_tcod",
                                          label = "Years Selected",
                                          min = 1958, max = 2013, value = c(1958, 2013), sep = ""),
                   "United Kingdom" = sliderInput("range_tcod",
                                                  label = "Years Selected",
                                                  min = 1950, max = 2014, value = c(1950, 2014), sep = ""),
                   "Japan" = sliderInput("range_tcod",
                                         label = "Years Selected",
                                         min = 1950, max = 2013, value = c(1950, 2013), sep = ""),
                   "Norway" = sliderInput("range_tcod",
                                          label = "Years Selected",
                                          min = 1951, max = 2012, value = c(1951, 2012), sep = ""),
                   "Sweden" = sliderInput("range_tcod",
                                          label = "Years Selected",
                                          min = 1952, max = 2012, value = c(1952, 2012), sep = ""),
                   "USA" = sliderInput("range_tcod",
                                        label = "Years Selected",
                                        min = 1959, max = 2015, value = c(1959, 2015), sep = "")
            )
        })
        
        #####help files in decomposition analysis tabs
        
        observeEvent(input$heatQA, {
            show_alert(
                title = NULL,
                text = tags$span(
                    tags$h3("Mortality Decomposition By Age",
                            style = "color: steelblue;"), tags$br(),
                    HTML("<em><b>Select Country, Time Interval, and Gender</b></em>"), 
                    tags$br(), tags$br(), tags$br(),
                    HTML("<b>Life Expectancy:</b> The user can compute the effects attributable to each relevant age group(s)."),
                    tags$br(), tags$br(),
                    HTML("<b>Life Preparancy:</b> The user can observe the change in life preparancy, and compute the 
                         effects attributable to each relevant age group(s)."),
                    tags$br(), tags$br(),
                    HTML("<b>Gender:</b> The user can observe the gender gap in life expectancy, and compute the 
                         effects attributable to each relevant age group(s)."), 
                    tags$br(), tags$br(),
                    icon("heart")
                ),
                html = TRUE
            )
        })
        
        observeEvent(input$CODQA, {
            show_alert(
                title = "",
                text = tags$span(
                    tags$h3("Mortality Decomposition By Age + Cause of Death",
                            style = "color: steelblue;"), tags$br(), 
                    HTML("<em><b>Select Country, Time Interval, Gender, and Input Age of Interest</b></em>"), 
                    tags$br(), tags$br(), tags$br(),
                    HTML("<b>Cause of Death:</b> The user can compute death rate for each cause-specific mortality to relevant age group(s)."),
                    tags$br(), tags$br(),
                    HTML("<b>Life Expectancy:</b> The user can compute the effects attributable to selected age group."),
                    tags$br(), tags$br(),
                    HTML("<b>Life Preparancy:</b> The user can compute the effects attributable to selected age group."),
                    tags$br(), tags$br(),
                    HTML("<b>Gender:</b> The user can compute the gender gap effects attributable to selected age group."), 
                    tags$br(), tags$br(),
                    icon("hand-holding-heart")
                ),
                html = TRUE
            )
        })
        
        # generate country list for by age sections
        sample_info <- reactive({
          sample_info <- read.csv("sampleoutput.csv", row.names = 1)
          colnames(sample_info) <- gsub("\\.", " ", colnames(sample_info))
          return(sample_info)
        })
        
        sample_info2 <- reactive({
          sample_info2 <- read.csv("sampleoutput2.csv")
          return(sample_info2)
        })
        
        # actual analysis used reactives
        country_info <- reactive({
            read.csv("List_Countries.csv")
        })
    
        res <- reactive({
            req(input$heatCountry) ; req(input$range_t)
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            res <- change5x1(chosen_country, input$range_t[1], input$range_t[2])
            return(res)
        })
        
        observe({
            updateSelectInput(session, inputId = 'heatCountry', label = 'Selected Country',
                              choices = unique(country_info()$Country), 
                              selected = input$heatCountry)
        })
        
        country_years <- reactive({
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            males5x1 <- readHMDweb(CNTRY = chosen_country, item = "mltper_5x1", username = getOption("HMD_user"), password = getOption("HMD_password"))
            return(males5x1$Year)
        })
        
        #heatmap
        output$HeatMap <- renderPlotly({
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
            
            if (length(input$heatGender) == 1){
                if (input$heatGender == "Male" ){ res_gender <- res()[[1]] }
                else if (input$heatGender == "Female" ){ res_gender <- res()[[2]]}

                par(mar=c(5.1,2.1,1,2.1))
                dim1 <- dim(res_gender)[[1]]
                hover_text <- matrix(paste0((sapply(colnames(res_gender), function(x) rep(x, dim1))), "<br>", 
                                            rep(rownames(res_gender), dim1), "<br>", 
                                            rep(input$heatGender, dim1*2), "<br>"),
                                     byrow = FALSE, ncol = dim1)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim1)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 0.9, cexCol = 0.9, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Expectancy (", 
                                                                    input$range_t[1], "-", input$range_t[2], ", ",
                                                                    input$heatGender, ", ", input$heatCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(gsub("LE Age ", "", colnames(res_gender))), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = as.numeric(gsub("Contribution Age ", "", rev(rownames(res_gender)))),
                                        title = "Contribution", showgrid = F, showticklabels = TRUE))
            
            }
            else{ 
                #if (input$heatAggregate == "FALSE"){ 

                    dim1 <- dim(res()[[1]])[[1]]
                    dim2 <- dim(res()[[2]])[[1]]
                    
                    res_gender <- cbind(res()[[1]], matrix(NA, nrow = dim1, ncol = 1), res()[[2]])
                    
                    ##create hover text
                    #males hover text
                    hover_text1 <- matrix(paste0((sapply(colnames(res()[[1]]), function(x) rep(x, dim1))), "<br>", 
                                                rep(rownames(res()[[1]]), dim1), "<br>", 
                                                rep("Male", dim1*2), "<br>"),
                                         byrow = FALSE, ncol = dim1)
                    hover_textM <- matrix(paste(hover_text1, round(res()[[1]], 4), sep="Change: "), dim1, dim1)
                    #females hover text
                    hover_text2 <- matrix(paste0((sapply(colnames(res()[[2]]), function(x) rep(x, dim2))), "<br>", 
                                                rep(rownames(res()[[2]]), dim2), "<br>", 
                                                rep("Female", dim2*2), "<br>"),
                                         byrow = FALSE, ncol = dim2)
                    hover_textF <- matrix(paste(hover_text2, round(res()[[2]], 4), sep="Change: "), dim2, dim2)
                    #NAs between males and females 
                    hover_textNA <- matrix(paste0("NA<br>NA<br>NA<br>Change: NA"), dim1, 1)
                    #final hover text
                    mat4 <- cbind(hover_textM, hover_textNA, hover_textF)
                    
                    #plotting heatmap M/F side to side
                    heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, #sepwidth=c(1.5, 1.5),
                            cexRow = 1, cexCol = 1, 
                            col = scale_colors, xlab = "", ylab = "", plot_method = c("plotly"),
                            main = paste0("Changes in Life Expectancy (", 
                                          input$range_t[1], "-", input$range_t[2], ", ",
                                          paste(input$heatGender, collapse = "/"), ", ", input$heatCountry, ")"),
                            font = list(size = 10), custom_hovertext = mat4,
                            key.title = "Changes in Years", margins = c(50, 100, NA, 0),
                            colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                            layout(xaxis = list(ticktext = gsub("LE Age ", "", colnames(res_gender)), title = "Age", 
                                                showgrid = F, tickangle = 0, showticklabels = TRUE), 
                                   yaxis = list(ticktext = as.numeric(gsub("Contribution Age ", "", rev(rownames(res_gender)))),
                                                title = "Contribution", showgrid = F, showticklabels = TRUE))
            }
        })
        
        
        # for maintaining the state of drill-down variables
        BarplotLE <- reactiveVal()
        BarplotLE_specific <- reactiveVal()

        # when clicking on a category, 
        observeEvent(event_data("plotly_click", source = "BarplotLE"), {
            BarplotLE(event_data("plotly_click", source = "BarplotLE")$x)
            BarplotLE_specific(NULL)
            #updateSelectInput(session, inputId = 'heatAge', selected = gsub("Age ", "", BarplotLE()))
        })
        
        
        output$BarplotLE <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$heatGender) >0, "Please Select Gender(s)")
            )
          
            #gender select
            if (length(input$heatGender) == 1){
                if (input$heatGender == "Male"){ res_gender <- res()[[1]] }
                else if (input$heatGender == "Female"){ res_gender <- res()[[2]] }
                else if (input$heatGender == "Population"){ res_gender <- res()[[1]] + res()[[2]] }
            
            
            #ecalculation of total
            print(BarplotLE())
            if (is.null(BarplotLE())){
                Total_male <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), row.names = colnames(res_gender)) %>% 
                    rownames_to_column() %>% mutate(curr_col = "#FDB863")
            }
            else{
                Total_male <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), row.names = colnames(res_gender)) %>% 
                    rownames_to_column() %>% mutate(curr_col = if_else(gsub("LE Age ", "", rowname) %in% BarplotLE(), "#8073AC", "#FDB863"))
            }
                
                p <- plot_ly(Total_male, x = ~gsub("LE Age ", "", rowname), y = ~le, type = "bar", 
                             source = "BarplotLE", marker = list(color = ~curr_col)) %>% 
                    config(displayModeBar = FALSE)
                p <- layout(p, barmode="overlay",
                            title = paste0("Changes in Life Expectancy (", 
                                    input$range_t[1], "-", input$range_t[2], ", ",
                                    input$heatGender, ", ", input$heatCountry, ")"),
                            font = list(size = 10),
                            xaxis = list(title = "Age", categoryarray = names(Total_male), 
                                         categoryorder = "array", tickangle = 0), 
                            yaxis = list(title = "Change (Years)"))
                p 
                
            }
            else{ 
                #if (input$heatAggregate == "FALSE"){ 
                    res_gender1 = res()[[1]]
                    res_gender2 = res()[[2]]
                    
                    print(BarplotLE())
                    if (is.null(BarplotLE())){
                        Total_male <- data.frame(le = apply(res_gender1, 2, sum, na.rm = TRUE), row.names = colnames(res_gender1)) %>% 
                            rownames_to_column() %>% mutate(curr_col = "#FDB863")
                        Total_female <- data.frame(le = apply(res_gender2, 2, sum, na.rm = TRUE), row.names = colnames(res_gender2)) %>% 
                            rownames_to_column() %>% mutate(curr_col = "#FD6363")
                    }
                    else{
                        Total_male <- data.frame(le = apply(res_gender1, 2, sum, na.rm = TRUE), row.names = colnames(res_gender1)) %>% 
                            rownames_to_column() %>% mutate(curr_col = if_else(gsub("LE Age ", "", rowname) %in% BarplotLE(), "#8073AC", "#FDB863"))
                        Total_female <- data.frame(le = apply(res_gender2, 2, sum, na.rm = TRUE), row.names = colnames(res_gender2)) %>% 
                            rownames_to_column() %>% mutate(curr_col = if_else(gsub("LE Age ", "", rowname) %in% BarplotLE(), "#92CCDE", "#FD6363"))
                    }
                    
                    p <- plot_ly(Total_male, x = ~gsub("LE Age ", "", rowname), y = ~le, type = "bar", name = 'Male',
                                 source = "BarplotLE", marker = list(color = ~curr_col)) %>%  config(displayModeBar = FALSE) %>% 
                          add_trace(data = Total_female, x = ~gsub("LE Age ", "", rowname), y = ~le, type = "bar", 
                                     name = 'Female', marker = list(color = ~curr_col)) %>% 
                          layout(barmode="group", title = paste0("Changes in Life Expectancy (", 
                                                                 input$range_t[1], "-", input$range_t[2], ", ",
                                                                 paste(input$heatGender, collapse = "/"), ", ", input$heatCountry, ")"), 
                                 font = list(size = 10),
                                 xaxis = list(title = "Age", categoryarray = names(Total_male), 
                                              categoryorder = "array", tickangle = 0), 
                                 yaxis = list(title = "Change (Years)"))
                    p
                #}
             #   else{
             #       res_gender = res()[[1]] + res()[[2]]
             #       print(BarplotLE())
             #       if (is.null(BarplotLE())){
             #           Total_male <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), row.names = colnames(res_gender)) %>% 
             #               rownames_to_column() %>% mutate(curr_col = "#FDB863")
             #       }
             #       else{
             #           Total_male <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), row.names = colnames(res_gender)) %>% 
             #               rownames_to_column() %>% mutate(curr_col = if_else(gsub("LE Age ", "", rowname) %in% BarplotLE(), "#8073AC", "#FDB863"))
             #       }
             #       
             #       p <- plot_ly(Total_male, x = ~gsub("LE Age ", "", rowname), y = ~le, type = "bar", 
             #                    source = "BarplotLE", marker = list(color = ~curr_col)) %>% 
             #           config(displayModeBar = FALSE)
             #       p <- layout(p, barmode="overlay",
             #                   title = paste0("Changes in Life Expectancy (", 
             #                                  input$range_t[1], "-", input$range_t[2], ", ",
             #                                  "Aggregate", ", ", input$heatCountry, ")"),
             #                   font = list(size = 8),
             #                   xaxis = list(title = "Age", categoryarray = names(Total_male), 
             #                                categoryorder = "array", size = 8, tickangle = 0), 
             #                   yaxis = list(title = "Change (Years)"))
             #       p 
             #   }
            }
        })
        
        
        
        output$BarplotLE_specific <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$heatGender) >0, "Please Select Gender(s)")
            )
          
            #once gender selected
            if (length(input$heatGender) == 1){
                if (input$heatGender == "Male"){ res_gender <- res()[[1]] }
                else if (input$heatGender == "Female"){ res_gender <- res()[[2]]}
                else if (input$heatGender == "Population") { res_gender <- res()[[1]] + res()[[2]] }
                
                if (is.null(BarplotLE())){  
                    p <- plotly_empty(type = "scatter", mode = "markers") %>%
                          config(displayModeBar = FALSE) %>%
                          layout(title = list(text = "Click on Each Bar for Decomposition Details", yref = "paper", y = 0.5))
                    return(p)
                }
                
                data.frame(contribution = res_gender[, paste("LE Age", BarplotLE())]) %>% 
                    rownames_to_column() %>% mutate(curr_color = "#8073AC") %>%
                    plot_ly(x = ~gsub("Contribution Age", "", rowname), y = ~contribution, source = "BarplotLE_specific", 
                            type = "bar", marker = list(color = ~curr_color)) %>% 
                    config(displayModeBar = FALSE) %>% 
                    layout(barmode="overlay",
                           title = paste0("Contribution of Change in Life Expectancy (", 
                                          input$range_t[1], "-", input$range_t[2], ", ",
                                          input$heatGender, ", ", BarplotLE(), ", ", 
                                          input$heatCountry, ")"), 
                           font = list(size = 10),
                           xaxis = list(title = "Contribution Age", categoryarray = ~rowname, 
                                        categoryorder = "array", tickangle = 0),
                           yaxis = list(title = "Contribution (Years)"))
                }
            else{
                #if (input$heatAggregate == "FALSE"){ 
                    if (is.null(BarplotLE())){
                        p <- plotly_empty(type = "scatter", mode = "markers") %>%
                            config(displayModeBar = FALSE) %>%
                            layout(title = list(text = "Click on Each Bar for Decomposition Details", yref = "paper", y = 0.5))
                        return(p)
                    } 
                    
                    res_gender1 = res()[[1]]
                    res_gender2 = res()[[2]]
                    
                    d1 <- data.frame(contribution = res_gender1[, paste("LE Age", BarplotLE())]) %>% 
                        rownames_to_column() %>% mutate(curr_color = "#8073AC") 
                    d2 <- data.frame(contribution = res_gender2[, paste("LE Age", BarplotLE())]) %>% 
                        rownames_to_column() %>% mutate(curr_col = "#92CCDE") 
                    
                    p <- plot_ly(data = d1, x = ~gsub("Contribution Age", "", rowname), y = ~contribution, source = "BarplotLE_specific", 
                                 type = "bar", marker = list(color = ~curr_color), name = "Male") %>%  config(displayModeBar = FALSE)  %>% 
                         add_trace(data = d2, x = ~gsub("Contribution Age", "", rowname),
                                  y = ~contribution, type = "bar", name = "Female", marker = list(color = ~curr_col)) %>% 
                         layout(barmode="group",
                                title = paste0("Contribution of Change in Life Expectancy (", 
                                               input$range_t[1], "-", input$range_t[2], ", ",
                                               paste0(input$heatGender, collapse = "/"), ", ", BarplotLE(), ", ", 
                                               input$heatCountry, ")"), 
                                font = list(size = 10),
                                xaxis = list(title = "Contribution Age", categoryarray = ~rowname, 
                                             categoryorder = "array", tickangle = 0),
                                yaxis = list(title = "Life Expectancy Change (Years)"))
                    p
                #}
                #else{
                #    if (is.null(BarplotLE())){  
                #        p <- plotly_empty(type = "scatter", mode = "markers") %>%
                #            config(displayModeBar = FALSE) %>%
                #            layout(title = list(text = "Click on Each Bar for Decomposition Details", yref = "paper", y = 0.5))
                #        return(p)
                #    }
                #    res_gender <- res()[[1]] + res()[[2]]
                #    
                #    data.frame(contribution = res_gender[, paste("LE Age", BarplotLE())]) %>% 
                #        rownames_to_column() %>% mutate(curr_color = "#8073AC") %>%
                #        plot_ly(x = ~gsub("Contribution Age", "", rowname), y = ~contribution, source = "BarplotLE_specific", 
                #                type = "bar", marker = list(color = ~curr_color)) %>% 
                #        config(displayModeBar = FALSE) %>% 
                #        layout(barmode="overlay",
                #               title = paste0("Contribution of Change in Life Expectancy (", 
                #                              input$range_t[1], "-", input$range_t[2], ", ",
                #                              "Aggregate", ", ", BarplotLE(), ", ", 
                #                              input$heatCountry, ")"), 
                #               font = list(size = 8),
                #               xaxis = list(title = "Contribution Age", categoryarray = ~rowname, 
                #                            categoryorder = "array", size = 8, tickangle = 0),
                #               yaxis = list(title = "Contribution (Years)"))
                #}
            }
                
         })
        
       # second tab
        
        LP_res <- reactive({
            req(input$heatCountry) ; req(input$range_t)
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            return(change5x1_LP(chosen_country, input$range_t[1], input$range_t[2], input$z))
        })
        
        output$LineLP <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$heatGender) >0, "Please Select Gender(s)")
            )
            
            #once gender selected
            plot_ly(LP_res()[[1]], x = ~initial, y = ~malet1, name = paste("Male", input$range_t[1]), 
                    type = 'scatter', mode = 'lines+markers',  
                    line = list(color = "#FDB863", dash = "dot"), 
                    marker = list(color = "#FDB863", symbol = "square", size = 10)) %>% 
                add_trace(y = ~femalet1, name = paste("Female", input$range_t[1]), mode = 'lines+markers',
                          line = list(color = "#FD6363", dash = "dot"), 
                          marker = list(color = "#FD6363", symbol = "square", size = 10)) %>% 
                add_trace(y = ~malet2, name = paste("Male", input$range_t[2]), mode = 'lines+markers',
                          line = list(color = "#8073AC", dash = "dash"), 
                          marker = list(color = "#8073AC", symbol = "circle", size = 10)) %>% 
                add_trace(y = ~femalet2, name = paste("Female", input$range_t[2]), mode = 'lines+markers',
                          line = list(color = "#92CCDE", dash = "dash"), 
                          marker = list(color = "#92CCDE", symbol = "circle", size = 10)) %>% 
                layout(title = paste0("Life Preparancy Per Age Group at ", scales::ordinal(input$z), " Percentile ", 
                                      "(", input$range_t[1], "-", input$range_t[2], ", ", input$heatCountry, ")"),
                       legend = list(orientation = "v", xanchor = "left", x = 0.10), 
                       font = list(size = 10), 
                       xaxis = list(title = "Age", tickangle = 0), 
                       yaxis = list(title = "Life Preparancy (Years)", tickangle = 0)) %>% 
                config(displayModeBar = FALSE)
         })
        
        
        output$HeatMapLP <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$heatGender) >0, "")
            )
          
            #start of analysis
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
            
            if (length(input$heatGender) == 1){
                if (input$heatGender == "Male" ){ res_gender <- LP_res()[[2]] }
                else if (input$heatGender == "Female" ){ res_gender <- LP_res()[[3]]}
                
                par(mar=c(5.1,2.1,1,2.1))
                dim1 <- dim(res_gender)[[1]]
                hover_text <- matrix(paste0((sapply(colnames(res_gender), function(x) rep(x, dim1))), "<br>", 
                                            rep(rownames(res_gender), dim1), "<br>", 
                                            rep(input$heatGender, dim1*2), "<br>"),
                                     byrow = FALSE, ncol = dim1)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim1)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 0.9, cexCol = 0.9, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Preparancy (", 
                                                                   input$range_t[1], "-", input$range_t[2], ", ",
                                                                   input$heatGender, ", ", input$heatCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(gsub("LP Age ", "", colnames(res_gender))), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = as.numeric(gsub("Contribution Age ", "", rev(rownames(res_gender)))),
                                        title = "Contribution", showgrid = F, showticklabels = TRUE))
                
            }
            else{ 
                #if (input$heatAggregate == "FALSE"){ 
                #dimensions
                dim1 <- dim(LP_res()[[2]])[[1]]
                dim2 <- dim(LP_res()[[3]])[[1]]                
                res_gender <- cbind(LP_res()[[2]], matrix(NA, nrow = dim1, ncol = 1), LP_res()[[3]])
                
                ##create hover text
                #males hover text
                hover_text1 <- matrix(paste0((sapply(colnames(LP_res()[[2]]), function(x) rep(x, dim1))), "<br>", 
                                             rep(rownames(LP_res()[[2]]), dim1), "<br>", 
                                             rep("Male", dim1*2), "<br>"),
                                      byrow = FALSE, ncol = dim1)
                hover_textM <- matrix(paste(hover_text1, round(LP_res()[[2]], 4), sep="Change: "), dim1, dim1)
                
                #females hover text
                hover_text2 <- matrix(paste0((sapply(colnames(LP_res()[[3]]), function(x) rep(x, dim2))), "<br>", 
                                             rep(rownames(LP_res()[[3]]), dim2), "<br>", 
                                             rep("Female", dim2*2), "<br>"),
                                      byrow = FALSE, ncol = dim2)
                hover_textF <- matrix(paste(hover_text2, round(LP_res()[[3]], 4), sep="Change: "), dim2, dim2)
                
                #NAs between males and females 
                hover_textNA <- matrix(paste0("NA<br>NA<br>NA<br>Change: NA"), dim1, 1)
                #final hover text
                mat4 <- cbind(hover_textM, hover_textNA, hover_textF)
                
                #plotting heatmap M/F side to side
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, #sepwidth=c(1.5, 1.5),
                          cexRow = 1, cexCol = 1, 
                          col = scale_colors, xlab = "", ylab = "", plot_method = c("plotly"),
                          main = paste0("Changes in Life Preparancy (", 
                                        input$range_t[1], "-", input$range_t[2], ", ",
                                        paste(input$heatGender, collapse = "/"), ", ", input$heatCountry, ")"),
                          font = list(size = 10), custom_hovertext = mat4,
                          key.title = "Changes in Years", margins = c(50, 100, NA, 0),
                          colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                  layout(xaxis = list(ticktext = gsub("LP Age ", "", colnames(res_gender)), title = "Age", 
                                      showgrid = F, tickangle = 0, showticklabels = TRUE), 
                         yaxis = list(ticktext = as.numeric(gsub("Contribution Age ", "", rev(rownames(res_gender)))),
                                      title = "Contribution", showgrid = F, showticklabels = TRUE))
            }
        })
        
        # third tab
        
        gap_age <- reactive({
            req(input$heatCountry) ; req(input$range_t)
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            return(GenGap_Age(chosen_country, input$range_t[1]))
        })
        
        output$GapAge <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$heatGender) >0, "Please Select Gender(s)")
            )
          
            plot_ly(gap_age()[[2]], x = ~age_interest, y = ~value, color = ~variable, type= 'bar', 
                    hoverinfo = "text", text = ~paste0("Age Group: ", age_interest, '</br></br>', 
                                                       "Contribution: ", variable, '</br>',
                                                       "Value: ", round(value, 4)))  %>%  
                layout(title = paste0("Contributions to Gender in Life Expectancy (", input$range_t[1], ")" ), 
                       yaxis = list(title = 'Contribution (Male - Female)'), barmode = 'stack', 
                       xaxis = list(title = "Age", categoryarray = names(gap_age()[[2]]), 
                                    categoryorder = "array", size = 10, tickangle = 0), 
                       showlegend = FALSE) %>% config(displayModeBar = FALSE)
        })
        
        #output$GapAgeTable <- renderDataTable(gap_age()[[1]], options = list(searching = FALSE, lengthMenu = c(15, 25, 50)))
        
    ### - start of decomposition by age and COD - ###
        
        observe({
            updateSelectInput(session, inputId = 'CODCountry', label = 'Selected Country',
                              choices = c("Canada", "Czech Republic", "France", 
                                          "United Kingdom", "Japan", "Norway", "Sweden", "USA"), 
                              selected = input$CODCountry)
        })
        
        COD_countries <- reactive({
            COD_countries <- data.frame(country = c("Canada", "Czech Republic", "France", "United Kingdom", "Japan", "Norway", "Sweden", "USA"),
                                        code = c("CAN", "CZE", "FRATNP", "GBRTENW", "JPN", "NOR", "SWE", "USA"))
        })
        
        chapters20 <- reactive({
            diagn<-c("Infectious","Cancer","Benign tumor","Blood","Endocrine/Nutrition",
                     "Mental Disorder","Nervous System","Heart Disease","Cerebrovascular","Circulatory",
                     "Respiratory","Digestive","Skin","Musculoskeletal","Genitourinary",
                     "Pregnancy/childbirth","Perinatal Conditions","Birth Defects","Unknown","External")
            data.frame(chapter = 1:length(diagn), diagn)
        })
        
        #extract from mortality_chapter_rates for specific age group
        chapter_rates_select <- reactive({
            req(input$CODCountry) ; req(input$range_tcod)
            #import the file
            chosen_country <- as.character(COD_countries()$code[which(COD_countries()$country == input$CODCountry)])
            chapter_rates <- mortality_chapter_rates(chosen_country, input$range_tcod[1], input$range_tcod[2])
            
            #picking your age group 
            age_initial <- colnames(chapter_rates[, -c(1:3)])
            selected_agegrp <- max(which((input$CODAge >= as.numeric(age_initial)) == TRUE)) + 3
            #find prop percent
            chapter_rates_select <- data.frame(chapter_rates[,c(1:3)], rate = chapter_rates[,selected_agegrp])
            
            #calculating proportion
            chapter_rates_select$perct = chapter_rates_select$rate/rep(chapter_rates_select[chapter_rates_select$chapter == 21,]$rate, each = 21)
            chapter_rates_select$chapter <- as.factor(chapter_rates_select$chapter)
            chapter_rates_select <- droplevels(chapter_rates_select[-which(chapter_rates_select$chapter == 21),])
            return(chapter_rates_select)
        })
        
        output$Animate_MCBar <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$CODGender) >0, "Please Select Gender(s)")
            )
          
            #gender select
            if (length(input$CODGender) == 1){
                
                chapter_rates_select_t1 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender & 
                                                                            chapter_rates_select()$year == input$range_tcod[1]),] 
                chapter_rates_select_t2 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender & 
                                                                            chapter_rates_select()$year == input$range_tcod[2]),] 
                chapter_rates_diff <- data.frame(chapter = rep(1:(max(chapters20()$chapter))),
                                                 chapter_rates_select_t2[,4:5] - chapter_rates_select_t1[,4:5])
                chapter_rates_diff <- merge(chapter_rates_diff, chapters20(), by = "chapter")
                
                #if no click
                chapter_rates_select_diff <- chapter_rates_diff %>% mutate(curr_col = "#FDB863")
                
                #plot barplot
                plot_ly(chapter_rates_select_diff, x = ~rate, y = ~diagn, type = "bar", marker = list(color = ~curr_col),
                        source = "Animate_MCBar", text = ~paste0("Cause of Death: ", diagn, '</br></br>', 
                                                                 "Change: ", round(rate, 4), '</br>',
                                                                 "Proportion: ", paste0(round(perct*100, 4), "%")), 
                        hoverinfo = "text", orientation = 'h') %>% 
                    config(displayModeBar = FALSE) %>% 
                    layout(barmode="overlay", title = paste0("Changes in Rate per 1000 (",
                                                             input$range_tcod[1], "-", input$range_tcod[2], ", ", 
                                                             input$CODGender, ", ", input$CODCountry, ")"),      
                           font = list(size = 10), xaxis = list(title = "Change in Rate (per 1000)", 
                               categoryarray = ~diagn, 
                               categoryorder = "array", tickangle = 0,
                               showgrid = FALSE), 
                           yaxis = list(title = "", autorange="reversed", showgrid = TRUE))
            }
            else{ 
                chapter_rates_select_t1_g1 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender[1] & 
                                                                               chapter_rates_select()$year == input$range_tcod[1]),] 
                chapter_rates_select_t2_g1 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender[1] & 
                                                                               chapter_rates_select()$year == input$range_tcod[2]),] 
                chapter_rates_select_t1_g2 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender[2] & 
                                                                               chapter_rates_select()$year == input$range_tcod[1]),] 
                chapter_rates_select_t2_g2 <- chapter_rates_select()[which(chapter_rates_select()$Gender == input$CODGender[2] & 
                                                                               chapter_rates_select()$year == input$range_tcod[2]),] 
                chapter_rates_diff1 <- data.frame(chapter = rep(1:(max(chapters20()$chapter))),
                                                  chapter_rates_select_t2_g1[,4:5] - chapter_rates_select_t1_g1[,4:5])
                chapter_rates_diff1 <- merge(chapter_rates_diff1, chapters20(), by = "chapter")
                chapter_rates_diff2 <- data.frame(chapter = rep(1:(max(chapters20()$chapter))),
                                                  chapter_rates_select_t2_g2[,4:5] - chapter_rates_select_t1_g2[,4:5])
                chapter_rates_diff2 <- merge(chapter_rates_diff2, chapters20(), by = "chapter")

                #male/female -- gender 1
                chapter_rates_select_diff1 <- chapter_rates_diff1 %>% mutate(curr_col = "#FDB863")
                #male/female -- gender 2
                chapter_rates_select_diff2 <- chapter_rates_diff2 %>% mutate(curr_col = "#FD6363")
                
                #plot 
                plot_ly(data = chapter_rates_select_diff1, x = ~rate, y = ~diagn, type = "bar", 
                        name = input$CODGender[1], marker = list(color = ~curr_col),
                        source = "Animate_MCBar", text = ~paste0("Cause of Death: ", diagn, '</br></br>', 
                                                                 "Gender: ", input$CODGender[1], '</br>', 
                                                                 "Year: ", paste0(input$range_tcod[1], "-", input$range_tcod[2]), '</br>',  
                                                                 "Change: ", round(rate, 4), '</br>',
                                                                 "Proportion: ", paste0(round(perct*100, 4), "%")), 
                        hoverinfo = "text", orientation = 'h') %>% 
                    config(displayModeBar = FALSE) %>% 
                    add_trace(data = chapter_rates_select_diff2, x = ~rate, y = ~diagn, type = "bar", 
                              name = input$CODGender[2], marker = list(color = ~curr_col), 
                              text = ~paste0("Cause of Death: ", diagn, '</br></br>', 
                                             "Gender: ", input$CODGender[2], '</br>', 
                                             "Year: ", paste0(input$range_tcod[1], "-", input$range_tcod[2]), '</br>', 
                                             "Change: ", round(rate, 4), '</br>',
                                             "Proportion: ", paste0(round(perct*100, 4), "%")), 
                              hoverinfo = "text", orientation = 'h') %>% 
                    layout(barmode="group", title = paste0("Changes in Death Rate per 1000 (",
                                                           input$range_tcod[1], "-", input$range_tcod[2], ", ", 
                                                           paste(input$heatGender, collapse = "/"), ", ", input$CODCountry, ")"),      
                           font = list(size = 10), xaxis = list(title = "Change in Rate (per 1000)", 
                                                               categoryarray = ~diagn, 
                                                               categoryorder = "array", size = 10, tickangle = 0, showgrid = FALSE), 
                           yaxis = list(title = "", autorange="reversed", showgrid = TRUE))
            }
        })

        # output
        Changes_age_cause <- reactive({
            #life expectancy
            req(input$CODCountry) ; req(input$range_tcod)
            chosen_country <- as.character(COD_countries()$code[which(COD_countries()$country == input$CODCountry)])
            #life expectancy
            res <- change5x1(chosen_country, input$range_tcod[1], input$range_tcod[2])
            #mortality chapters
            res_COD <- change5x1_AgeCOD(chosen_country, input$range_tcod[1], input$range_tcod[2])
            #age group 
            mortality_chapters = 20
            age_initial <- gsub("LE Age ", "", colnames(res[[1]]))
            age_groups <- dim(res_COD[[1]])[2]
            selected_agegrp <- max(which((input$CODAge >= as.numeric(age_initial)) == TRUE))
            
            #final output
            Changes_age_cause_male<-matrix(0,nrow=mortality_chapters,ncol=age_groups)
            Changes_age_cause_female<-matrix(0,nrow=mortality_chapters,ncol=age_groups)
            for(x in 1:age_groups){
                Changes_age_cause_male[,x]<-res[[1]][x,selected_agegrp]*res_COD[[1]][,x]
                Changes_age_cause_female[,x]<-res[[2]][x,selected_agegrp]*res_COD[[2]][,x]
            }
            colnames(Changes_age_cause_male) <- age_initial
            colnames(Changes_age_cause_female) <- age_initial
            rownames(Changes_age_cause_male) <- 1:mortality_chapters
            rownames(Changes_age_cause_female) <- 1:mortality_chapters
            return(list(Changes_age_cause_male, Changes_age_cause_female))
        })
        
        # for maintaining the state of drill-down variables
        BarplotLE_AgeCOD <- reactiveVal()
        BarplotLE_specificAgeCOD <- reactiveVal()
        
        # when clicking on a category, 
        observeEvent(event_data("plotly_click", source = "BarplotLE_AgeCOD"), {
            BarplotLE_AgeCOD(event_data("plotly_click", source = "BarplotLE_AgeCOD")$x)
            BarplotLE_specificAgeCOD(NULL)
        })
        
        output$BarplotLE_AgeCOD <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$CODGender) >0, "Please Select Gender(s)")
            )
          
            #gender select
            if (length(input$CODGender) == 1){
                if (input$CODGender == "Male"){ res_gender <- Changes_age_cause()[[1]] }
                else if (input$CODGender == "Female"){ res_gender <- Changes_age_cause()[[2]] }
                #calculation of total
                print(BarplotLE_AgeCOD())
                if (is.null(BarplotLE_AgeCOD())){
                    Total_age_cause <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender)) %>% 
                                                rownames_to_column() %>% mutate(curr_col = "#FDB863")
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_age_cause$rowname)) == TRUE))
                }
                else{
                    Total_age_cause <- data.frame(le = apply(res_gender, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender)) %>% 
                                                rownames_to_column() %>% mutate(curr_col = if_else(rowname %in% BarplotLE_AgeCOD(), "#8073AC", "#FDB863"))
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_age_cause$rowname)) == TRUE))
                }
                
                plot_ly(Total_age_cause[c(selected_agegrp:23),], x = ~rowname, y = ~le, type = "bar", 
                        source = "BarplotLE_AgeCOD", marker = list(color = ~curr_col)) %>% 
                    config(displayModeBar = FALSE) %>% 
                    layout(p, barmode="overlay", title = paste0("Changes in Life Expectancy (",
                                                                input$range_tcod[1], "-", input$range_tcod[2], ", ", 
                                                                input$CODGender, ", ", input$CODCountry, ")"),      
                           font = list(size = 10), xaxis = list(title = "Age", 
                                                               categoryarray = names(Total_age_cause[c(selected_agegrp:23),]), 
                                                               categoryorder = "array", tickangle = 0), 
                           yaxis = list(title = "Change (Years)"))
            }
            else{ 
                res_gender1 = Changes_age_cause()[[1]]
                res_gender2 = Changes_age_cause()[[2]]
                
                print(BarplotLE_AgeCOD())
                if (is.null(BarplotLE_AgeCOD())){
                    
                    #male
                    Total_male_age_cause <- data.frame(le = apply(res_gender1, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender1)) %>% 
                        rownames_to_column() %>% mutate(curr_col = "#FDB863")
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_male_age_cause$rowname)) == TRUE))
        
                    #female
                    Total_female_age_cause <- data.frame(le = apply(res_gender2, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender2)) %>% 
                        rownames_to_column() %>% mutate(curr_col = "#FD6363")
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_female_age_cause$rowname)) == TRUE))
                    
                }
                else{
                    #male
                    Total_male_age_cause <- data.frame(le = apply(res_gender1, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender1)) %>% 
                        rownames_to_column() %>% mutate(curr_col = if_else(rowname %in% BarplotLE_AgeCOD(), "#8073AC", "#FDB863"))
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_male_age_cause$rowname)) == TRUE))
                    
                    #female
                    Total_female_age_cause <- data.frame(le = apply(res_gender2, 2, sum, na.rm = TRUE), 
                                                       row.names = colnames(res_gender2)) %>% 
                        rownames_to_column() %>% mutate(curr_col = if_else(rowname %in% BarplotLE_AgeCOD(), "#92CCDE", "#FD6363"))
                    selected_agegrp <- max(which((input$CODAge >= as.numeric(Total_male_age_cause$rowname)) == TRUE))
                    
                }
                
                p <- plot_ly(Total_male_age_cause[c(selected_agegrp:23),], x = ~rowname, y = ~le, type = "bar", name = 'Male',
                             source = "BarplotLE_AgeCOD", marker = list(color = ~curr_col)) %>%  config(displayModeBar = FALSE) %>% 
                    add_trace(data = Total_female_age_cause[c(selected_agegrp:23),], x = ~rowname, y = ~le, type = "bar", 
                              name = 'Female', marker = list(color = ~curr_col)) %>% 
                    layout(barmode="group", title = paste0("Changes in Life Expectancy (", 
                                                           input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                                           paste(input$CODGender, collapse = "/"), ", ", input$CODCountry, ")"), 
                           font = list(size = 10),
                           xaxis = list(title = "Age", categoryarray = names(Total_male_age_cause[c(selected_agegrp:23),]), 
                                        categoryorder = "array", tickangle = 0), 
                           yaxis = list(title = "Change (Years)"))
                p
            }
        })
        
        output$BarplotLE_specificAgeCOD <- renderPlotly({
          
          #we need to select gender
          shiny::validate(
            need(length(input$CODGender) >0, "Please Select Gender(s)")
          )
          
            if (length(input$CODGender) == 1){
                if (input$CODGender == "Male"){ res_gender <- Changes_age_cause()[[1]] }
                else if (input$CODGender == "Female"){ res_gender <- Changes_age_cause()[[2]]}

                if (is.null(BarplotLE_AgeCOD())){  
                    p <- plotly_empty(type = "scatter", mode = "markers") %>%
                        config(displayModeBar = FALSE) %>%
                        layout(title = list(text = "Click on Each Bar for Decomposition Details", yref = "paper", y = 0.5))
                    return(p)
                }
                
                print(BarplotLE_AgeCOD())
                data.frame(contribution = res_gender[, BarplotLE_AgeCOD()]) %>% 
                    rownames_to_column() %>% mutate(curr_color = "#8073AC") %>%
                    mutate(rowname = as.integer(rowname)) %>% 
                    inner_join(chapters20(), by = c("rowname" = "chapter")) %>% 
                    plot_ly(x = ~rowname, y = ~contribution, source = "BarplotLE_specificAgeCOD", 
                            type = "bar", marker = list(color = ~curr_color), 
                            hoverinfo = "text", text = ~paste0("Cause of Death: ", diagn, '</br></br>', 
                                                               "Contribution: ", round(contribution, 4), '</br>')) %>% 
                    config(displayModeBar = FALSE) %>% 
                    layout(barmode="overlay",
                           title = paste0("Contribution of Change in Life Expectancy (", 
                                          input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                          input$CODGender, ", ", BarplotLE_AgeCOD(), ", ", 
                                          input$CODCountry, ")"), 
                           font = list(size = 10),
                           xaxis = list(tickvals = 1:20,
                                        title = "Contribution Cause of Death", categoryarray = ~rowname, 
                                        categoryorder = "array", tickangle = 0, showticklabels = TRUE),
                           yaxis = list(title = "Contribution (Years)"))
                
            }
            else{
                
                print(BarplotLE_AgeCOD())
                if (is.null(BarplotLE_AgeCOD())){
                    p <- plotly_empty(type = "scatter", mode = "markers") %>%
                        config(displayModeBar = FALSE) %>%
                        layout(title = list(text = "Click on Each Bar for Decomposition Details", yref = "paper", y = 0.5))
                    return(p)
                } 
                
                res_gender1 = Changes_age_cause()[[1]]
                res_gender2 = Changes_age_cause()[[2]]
                
                d1 <- data.frame(contribution = res_gender1[, BarplotLE_AgeCOD()]) %>% 
                          rownames_to_column() %>% mutate(curr_color = "#8073AC") %>% 
                          mutate(rowname = as.integer(rowname)) %>% 
                          inner_join(chapters20(), by = c("rowname" = "chapter"))
                d2 <- data.frame(contribution = res_gender2[, BarplotLE_AgeCOD()]) %>% 
                          rownames_to_column() %>% mutate(curr_col = "#92CCDE") %>% 
                          mutate(rowname = as.integer(rowname)) %>% 
                          inner_join(chapters20(), by = c("rowname" = "chapter"))
                
                p <- plot_ly(data = d1, x = ~rowname, y = ~contribution, source = "BarplotLE_specificAgeCOD", 
                             type = "bar", marker = list(color = ~curr_color), name = "Male", 
                             hoverinfo = "text", text = ~paste0("Cause of Death: ", diagn, '</br></br>', 
                                                                "Contribution: ", round(contribution, 4), '</br>')) %>%  
                    config(displayModeBar = FALSE)  %>% 
                    add_trace(data = d2, x = ~rowname, y = ~contribution, type = "bar", 
                              name = "Female", marker = list(color = ~curr_col)) %>% 
                    layout(barmode="group",
                           title = paste0("Contribution of Change in Life Expectancy (", 
                                          input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                          paste0(input$CODGender, collapse = "/"), ", ", BarplotLE_AgeCOD(), ", ", 
                                          input$CODCountry, ")"), 
                           font = list(size = 10),
                           xaxis = list(tickvals = 1:20,  
                                        title = "Contribution Cause of Death", categoryarray = ~rowname, 
                                        categoryorder = "array", tickangle = 0, showticklabels = TRUE),
                           yaxis = list(title = "Contribution (Years)"))
                p
            }
            
        })
        
       ###heatmap COD
        output$HeatMap_AgeCOD <- renderPlotly({
          
          #we need to select gender
          shiny::validate(
            need(length(input$CODGender) >0, "")
          )
          
          #start of analysis if gender chosen
            chosen_country <- as.character(country_info()$Code[which(country_info()$Country == input$heatCountry)])
            scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
            
            if (length(input$CODGender) == 1){
                if (input$CODGender == "Male" ){ res_gender <- Changes_age_cause()[[1]] }
                else if (input$CODGender == "Female" ){ res_gender <- Changes_age_cause()[[2]]}
                
                par(mar=c(5.1,2.1,1,2.1))
                dim1 <- dim(res_gender)[[1]]
                dim2 <- dim(res_gender)[[2]]
                hover_text <- matrix(paste0("Age: ", sapply(colnames(res_gender), function(x) rep(x, dim1)), "<br>", 
                                     "Cause of Death: ", rep(chapters20()$diagn, dim2), "<br>", 
                                     rep(input$CODGender, dim1*dim2), "<br>"),
                                     byrow = FALSE, ncol = dim2)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim2)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 1, cexCol = 1, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Expectancy (", 
                                                                   input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                                                   input$CODGender, ", ", input$CODAge, ", ", input$CODCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(colnames(res_gender)), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = rev(chapters20()$diagn), title = "",
                                       # title = paste0(c(rep("&nbsp;", 20), "Contribution",
                                       #                  rep("&nbsp;", 20), rep("\n&nbsp;", 1)), collapse = ""),
                                        showgrid = F, showticklabels = TRUE))
                
            }
            else{ 
                #if (input$heatAggregate == "FALSE"){ 
                res_gender <- Changes_age_cause()[[2]] - Changes_age_cause()[[1]]
                
                #par(mar=c(5.1,5.1,1,2.1))
                dim1 <- dim(res_gender)[[1]]
                dim2 <- dim(res_gender)[[2]]
                hover_text <- matrix(paste0("Age: ", sapply(colnames(res_gender), function(x) rep(x, dim1)), "<br>", 
                                            "Cause of Death: ", rep(chapters20()$diagn, dim2), "<br>", 
                                            rep("Female - Male", dim1*dim2), "<br>"),
                                     byrow = FALSE, ncol = dim2)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim2)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 1, cexCol = 1, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Expectancy (", 
                                                                   input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                                                   "Female - Male", ", ", input$CODAge, ", ", input$CODCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(colnames(res_gender)), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = rev(chapters20()$diagn), title = "",
                                       # title = paste0(c(rep("&nbsp;", 20), "Contribution",
                                       #                  rep("&nbsp;", 20), rep("\n&nbsp;", 1)), collapse = ""),
                                        showgrid = F, showticklabels = TRUE))
            }
        })
        
       ### life preparancy for COD 
        
        # output
        Changes_age_cause_LP <- reactive({
            #life preparancy chosen country
            req(input$CODCountry)
            chosen_country <- as.character(COD_countries()$code[which(COD_countries()$country == input$CODCountry)])
            #life preparancy
            res <- change5x1_LP(chosen_country, input$range_tcod[1], input$range_tcod[2], input$CODz)
            res[[2]][is.na(res[[2]])]<-0 #LP change males set to 0 for NAs
            res[[3]][is.na(res[[3]])]<-0 #LP change females set to 0 for NAs
            #mortality chapters
            res_COD <- change5x1_AgeCOD(chosen_country, input$range_tcod[1], input$range_tcod[2])
            #age group 
            mortality_chapters = 20
            age_initial <- gsub("LP Age ", "", colnames(res[[2]]))
            age_groups <- dim(res_COD[[1]])[2]
            selected_agegrp <- max(which((input$CODAge >= as.numeric(age_initial)) == TRUE))
            
            #final output
            Changes_age_cause_male<-matrix(0,nrow=mortality_chapters,ncol=age_groups-1)
            Changes_age_cause_female<-matrix(0,nrow=mortality_chapters,ncol=age_groups-1)
            for(x in 1:age_groups-1){
                Changes_age_cause_male[,x]<-res[[2]][x,selected_agegrp]*res_COD[[1]][,x] #res[[2]] for male
                Changes_age_cause_female[,x]<-res[[3]][x,selected_agegrp]*res_COD[[2]][,x] #res[[3]] for female
            }
            colnames(Changes_age_cause_male) <- age_initial
            colnames(Changes_age_cause_female) <- age_initial
            rownames(Changes_age_cause_male) <- 1:mortality_chapters
            rownames(Changes_age_cause_female) <- 1:mortality_chapters
            return(list(Changes_age_cause_male, Changes_age_cause_female))
        })
        
        output$HeatMapLP_COD <- renderPlotly({
          #we need to select gender
          shiny::validate(
            need(length(input$CODGender) >0, "Please Select Gender(s)")
          )
          
            chosen_country <- as.character(COD_countries()$code[which(COD_countries()$country == input$CODCountry)])
            scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
            
            if (length(input$CODGender) == 1){
                if (input$CODGender == "Male" ){ res_gender <- Changes_age_cause_LP()[[1]] }
                else if (input$CODGender == "Female" ){ res_gender <- Changes_age_cause_LP()[[2]]}
                
                dim1 <- dim(res_gender)[[1]]
                dim2 <- dim(res_gender)[[2]]
                hover_text <- matrix(paste0("Age: ", sapply(colnames(res_gender), function(x) rep(x, dim1)), "<br>", 
                                            "Cause of Death: ", rep(chapters20()$diagn, dim2), "<br>", 
                                            rep(input$CODGender, dim1*dim2), "<br>"),
                                     byrow = FALSE, ncol = dim2)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim2)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 1, cexCol = 1, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Preparancy (", 
                                                                   input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                                                   input$CODGender, ", ", input$CODAge, ", ", input$CODCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(colnames(res_gender)), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = rev(chapters20()$diagn), title = "",
                                        showgrid = F, showticklabels = TRUE))
                
            }
            else{ 
                res_gender <- Changes_age_cause_LP()[[2]] - Changes_age_cause_LP()[[1]]
                #dimensions
                dim1 <- dim(res_gender)[[1]]
                dim2 <- dim(res_gender)[[2]]
                hover_text <- matrix(paste0("Age: ", sapply(colnames(res_gender), function(x) rep(x, dim1)), "<br>", 
                                            "Cause of Death: ", rep(chapters20()$diagn, dim2), "<br>", 
                                            rep("Female - Male", dim1*dim2), "<br>"),
                                     byrow = FALSE, ncol = dim2)
                hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim2)
                
                heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                          cexRow = 1, cexCol = 1, col = scale_colors,  
                          plot_method = c("plotly"), main = paste0("Changes in Life Preparancy (", 
                                                                   input$range_tcod[1], "-", input$range_tcod[2], ", ",
                                                                   "Female - Male", ", ", input$CODAge, ", ", input$CODCountry, ")"), 
                          font = list(size = 10), custom_hovertext = hover_text2, 
                          key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                    layout(xaxis = list(ticktext = as.numeric(colnames(res_gender)), title = "Age", 
                                        showgrid = F, tickangle = 0, showticklabels = TRUE), 
                           yaxis = list(ticktext = rev(chapters20()$diagn), title = "",
                                        showgrid = F, showticklabels = TRUE))
            }
        })
        
        ### start of gender gap tab
        
        Changes_age_cause_gap <- reactive({
            
            #life expectancy
            req(input$CODCountry) ; req(input$range_tcod)
            chosen_country <- as.character(COD_countries()$code[which(COD_countries()$country == input$CODCountry)])
            
            #GenGap function for per age outputs: change per age (unmelt, melt), change per age lower triangle
            Gender_Gap_Age <- GenGap_Age(chosen_country, input$range_tcod[1])
            #GenGap function outputs: mortality fractions M,F and mortality rates per chapter M,F
            res <- GenGap_AgeCOD(chosen_country, input$range_tcod[1])
            
            #parameters
            mortality_chapters = max(chapters20()$chapter) #number of chapters
            age_initial <- colnames(res[[1]])
            age_groups <- dim(res[[1]])[2] #number of agegroups
            selected_agegrp <- max(which((input$CODAge >= as.numeric(age_initial)) == TRUE))
            
            #total rates
            Total_rate_M <- res[[3]][mortality_chapters+1,]
            Total_rate_F <- res[[4]][mortality_chapters+1,] 
            
            #gender gap distribution
            Gender_Gap_Distribution <- Gender_Gap_Age[[3]][-nrow(Gender_Gap_Age[[3]]), selected_agegrp]
            Contribution_per_cause<-matrix(0,nrow=mortality_chapters,ncol=age_groups)
            ##difference in ratios to calc gender gap by mortality chapter
            Ratio_of_Differences<-matrix(0,nrow=mortality_chapters,ncol=age_groups)
            for(i in 1:mortality_chapters){
                Ratio_of_Differences[i,] <- (res[[2]][i,]*Total_rate_F-res[[1]][i,]*Total_rate_M)/(Total_rate_F-Total_rate_M)    
                Contribution_per_cause[i,] <- Ratio_of_Differences[i,]*Gender_Gap_Distribution                           
            }
            Contribution_per_cause[is.na(Contribution_per_cause)] <- 0 ##NAs may be generated if rate in denominator is zero for an age(happens for 105+)
            Total_Cause<-apply(Contribution_per_cause,1,sum)
            result<-cbind(Contribution_per_cause,Total_Cause)
            colnames(result) = c(age_initial, "Total")
            return(result)
            
        })
        
        #sample outputs shown in the instructions 
        
        output$GapAgeCOD <- renderPlotly({
            #we need to select gender
            shiny::validate(
              need(length(input$CODGender) >0, "Please Select Gender(s)")
            )
          
            scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
            
            res_gender <- Changes_age_cause_gap()[,-ncol(Changes_age_cause_gap())]
            dim1 <- dim(res_gender)[[1]]
            dim2 <- dim(res_gender)[[2]]
            hover_text <- matrix(paste0("Age: ", sapply(colnames(res_gender), function(x) rep(x, dim1)), "<br>", 
                                        "Cause of Death: ", rep(chapters20()$diagn, dim2), "<br>", 
                                        rep("Female - Male", dim1*dim2), "<br>"),
                                 byrow = FALSE, ncol = dim2)
            hover_text2 <- matrix(paste(hover_text, round(res_gender, 4), sep="Change: "), dim1, dim2)
            
            heatmaply(res_gender, dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                      cexRow = 1, cexCol = 1, col = scale_colors,  
                      plot_method = c("plotly"), main = paste0("Gender Gap in Life Expectancy (", 
                                                               input$range_tcod[1], ", ",
                                                               "Female - Male", ", ", input$CODAge, ", ", input$CODCountry, ")"), 
                      font = list(size = 10), custom_hovertext = hover_text2, 
                      key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
                layout(xaxis = list(ticktext = as.numeric(colnames(res_gender)), title = "Age", 
                                    showgrid = F, tickangle = 0, showticklabels = TRUE), 
                       yaxis = list(ticktext = rev(chapters20()$diagn), title = "",
                                    showgrid = F, showticklabels = TRUE))
        })
        
        
        
        output$test_barplot <- renderPlotly({
          #plotting taiwan 2000-2010 as sample output imported from read csv
          Total_male <- data.frame(le = apply(sample_info(), 2, sum, na.rm = TRUE), row.names = colnames(sample_info())) %>% 
            rownames_to_column() %>% mutate(curr_col = "#FDB863")
          
          p <- plot_ly(Total_male, x = ~gsub("LE Age ", "", rowname), y = ~le, type = "bar", 
                       source = "BarplotLE", marker = list(color = ~curr_col)) %>% 
            config(displayModeBar = FALSE)
          p <- layout(p, barmode="overlay",
                      title = list(text = paste0("Changes in Life Expectancy (", 
                                     2000, "-", 2010, ", ",
                                     "Male", ", ", "Taiwan", ")"), font = list(size = 16)),
                      font = list(size = 12),
                      xaxis = list(title = "Age", categoryarray = names(Total_male), 
                                   categoryorder = "array", size = 8, tickangle = 0), 
                      yaxis = list(title = "Change (Years)"))
          p 
        })
        
        output$test_heatmap <- renderPlotly({
          #plotting taiwan 2000-2010 as sample output imported from read csv
          scale_colors <- brewer.pal(n=9, name = "YlOrRd") #selection of
          
          dim1 <- dim(sample_info())[[1]]
          hover_text <- matrix(paste0((sapply(colnames(sample_info()), function(x) rep(x, dim1))), "<br>", 
                                      rep(rownames(sample_info()), dim1), "<br>", 
                                      rep("Male", dim1*2), "<br>"),
                               byrow = FALSE, ncol = dim1)
          hover_text2 <- matrix(paste(hover_text, round(as.matrix(sample_info()), 4), sep="Change: "), dim1, dim1)
          
          heatmaply(sample_info(), dendrogram = "none", Rowv = FALSE, Colv = FALSE, 
                    cexRow = 0.9, cexCol = 0.9, col = scale_colors,  
                    plot_method = c("plotly"), main = paste0("Changes in Life Expectancy (", 
                                                             2000, "-", 2010, ", ",
                                                             "Male", ", ", "Taiwan", ")"), 
                    font = list(size = 8), custom_hovertext = hover_text2, 
                    key.title = "Changes in Years", colorbar_xpos = 30, colorbar_ypos = 10) %>% 
            layout(xaxis = list(ticktext = as.numeric(gsub("LE Age ", "", colnames(sample_info()))), title = "Age", 
                                showgrid = F, tickangle = 0, showticklabels = TRUE), 
                   yaxis = list(ticktext = as.numeric(gsub("Contribution Age ", "", rev(rownames(sample_info())))),
                                title = "Contribution", showgrid = F, showticklabels = TRUE))
        })
        
        output$test_lineplot <- renderPlotly({

          plot_ly(sample_info2(), x = ~initial, y = ~malet1, name = paste("Male", 2000), 
                  type = 'scatter', mode = 'lines+markers',  
                  line = list(color = "#FDB863", dash = "dot"), 
                  marker = list(color = "#FDB863", symbol = "square", size = 10)) %>% 
            add_trace(y = ~femalet1, name = paste("Female", 2000), mode = 'lines+markers',
                      line = list(color = "#FD6363", dash = "dot"), 
                      marker = list(color = "#FD6363", symbol = "square", size = 10)) %>% 
            add_trace(y = ~malet2, name = paste("Male", 2010), mode = 'lines+markers',
                      line = list(color = "#8073AC", dash = "dash"), 
                      marker = list(color = "#8073AC", symbol = "circle", size = 10)) %>% 
            add_trace(y = ~femalet2, name = paste("Female", 2010), mode = 'lines+markers',
                      line = list(color = "#92CCDE", dash = "dash"), 
                      marker = list(color = "#92CCDE", symbol = "circle", size = 10)) %>% 
            layout(title = paste0("Life Preparancy Per Age Group at ", scales::ordinal(0.9*100), " Percentile ", 
                                  "(", 2000, "-", 2010, ", ", "Taiwan", ")"),
                   legend = list(orientation = "v", xanchor = "left", x = 0.10), 
                   font = list(size = 12), 
                   xaxis = list(title = "Age", size = 20, tickangle = 0), 
                   yaxis = list(title = "Life Preparancy (Years)", size = 8, tickangle = 0)) %>% 
            config(displayModeBar = FALSE)
          
        })

})


shinyApp(ui, server)

